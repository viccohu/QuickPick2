<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickPick2 - 图片查看管理器</title>
  <link rel="stylesheet" href="./assets/remixicon.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #0a0a0a;
      overflow: hidden;
    }

    /* 标题栏 - 黑色主题 */
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 20px;
      background: rgba(20, 20, 20, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
      -webkit-app-region: drag;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .window-title {
      font-weight: 600;
      font-size: 13px;
      color: #e0e0e0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .window-title i {
      font-size: 16px;
      color: #667eea;
    }

    .title-bar-center {
      display: flex;
      align-items: center;
      gap: 12px;
      -webkit-app-region: no-drag;
    }

    .title-bar-stats {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 4px;
      font-size: 11px;
      color: #888;
    }

    .title-bar-stats-item {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .title-bar-stats-item i {
      font-size: 10px;
      color: #667eea;
    }

    .title-bar-stats-divider {
      width: 1px;
      height: 12px;
      background: rgba(255, 255, 255, 0.1);
      margin: 0 4px;
    }

    .title-bar-help {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      transition: all 0.2s;
    }

    .title-bar-help:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    /* 窗口控制按钮 - 黑色主题 */
    .window-controls {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .control-button {
      width: 40px;
      height: 28px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      color: #888;
    }

    .control-button:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    .control-button.close:hover {
      background: #e81123;
      color: white;
    }

    .control-button:active {
      transform: scale(0.95);
    }

    /* 主容器 */
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #0a0a0a;
    }

    /* 顶部路径管理模块 - 黑色主题 */
    .path-container {
      display: flex;
      padding: 10px 20px;
      background: rgba(18, 18, 18, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      gap: 16px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .path-item {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .path-label {
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
      color: #888;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .path-label i {
      font-size: 14px;
      color: #667eea;
    }

    .path-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      font-size: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
    }

    .path-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    .path-button {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }

    .path-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    }

    .path-button:active {
      transform: translateY(0);
    }

    /* 中间预览区域 - 黑色主题 */
    .preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 100%);
      position: relative;
      min-height: 200px;
    }

    .preview-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .preview-image {
      max-width: 100%;
      max-height: 100%;
      cursor: grab;
      transition: transform 0.1s ease-out;
    }

    .preview-image:active {
      cursor: grabbing;
    }

    /* 星级评级控件 - 黑色主题 */
    .rating-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 16px;
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      color: white;
      gap: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .rating-stars {
      display: flex;
      gap: 5px;
    }

    .batch-info-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(102, 126, 234, 0.15);
      border-radius: 4px;
      font-size: 12px;
      color: #667eea;
    }

    .batch-info-inline strong {
      font-weight: 600;
    }

    .batch-cancel-inline {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      padding: 2px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .batch-cancel-inline:hover {
      color: #e0e0e0;
    }

    .star {
      font-size: 18px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .star:hover {
      color: #667eea;
      transform: scale(1.1);
    }

    .star.active {
      color: #667eea;
      text-shadow: 0 0 10px rgba(102, 126, 234, 0.4);
    }

    /* 底部缩略图区域 - 黑色主题 */
    .thumbnail-container {
      height: 112px;
      background: rgba(15, 15, 15, 0.98);
      backdrop-filter: blur(20px);
      padding: 12px 20px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      flex-shrink: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .thumbnail-wrapper {
      display: inline-flex;
      gap: 4px;
      align-items: flex-start;
    }

    .thumbnail-item {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      margin-right: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: visible;
      background: #2a2a2a;
    }

    .thumbnail-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .thumbnail-item.active {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .thumbnail-image-wrapper {
      position: relative;
      width: 120px;
      height: 70px;
      background: #2a2a2a;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.045) 100%);
      border-radius: 4px 4px 0 0;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .thumbnail-item:hover .thumbnail-overlay {
      opacity: 1;
    }

    .thumbnail-format {
      position: absolute;
      padding: 2px 4px;
      border-radius: 2px;
      font-size: 8px;
      font-weight: 500;
      background: rgba(40, 40, 40, 0.9);
      color: #888;
      z-index: 1;
    }

    .thumbnail-format.jpg {
      top: 3px;
      left: 3px;
    }

    .thumbnail-format.raw {
      top: 3px;
      right: 3px;
    }

    .thumbnail-rating {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1px;
      padding: 3px 0;
      background: #1a1a1a;
      border-radius: 0 0 4px 4px;
    }

    .thumbnail-star {
      font-size: 10px;
      cursor: pointer;
      color: #444;
      transition: all 0.15s ease;
    }

    .thumbnail-star:hover {
      color: #667eea;
      transform: scale(1.1);
    }

    .thumbnail-star.active {
      color: #667eea;
    }

    /* 操作栏 - 黑色主题 */
    .toolbar {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: rgba(18, 18, 18, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      gap: 16px;
      flex-shrink: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }

    .filter-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 4px;
    }

    .filter-btn {
      width: 36px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .filter-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.25);
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      font-size: 13px;
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    .filter-stars {
      display: none;
      gap: 4px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-stars.visible {
      display: flex;
    }

    .filter-star {
      font-size: 18px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.15);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-star:hover {
      color: #667eea;
      transform: scale(1.2);
    }

    .filter-star.active {
      color: #667eea;
      text-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
    }

    .filter-status {
      margin-left: 12px;
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .export-button {
      margin-left: auto;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }

    .export-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    }

    .export-button:active {
      transform: translateY(0);
    }

    .help-button {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .help-button:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .magnifier-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .magnifier-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .magnifier-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    /* 快捷键帮助弹窗 */
    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .help-modal.visible {
      display: flex;
    }

    .help-modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .help-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .help-modal-header h3 {
      color: #e0e0e0;
      font-size: 18px;
      font-weight: 600;
    }

    .help-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .help-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .help-modal-body {
      padding: 24px;
    }

    .help-section {
      margin-bottom: 24px;
    }

    .help-section:last-child {
      margin-bottom: 0;
    }

    .help-section h4 {
      color: #667eea;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .help-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 14px;
    }

    .key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      font-family: monospace;
    }

    /* 无图片提示 - 黑色主题 */
    .no-image {
      color: rgba(255, 255, 255, 0.3);
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .no-image i {
      font-size: 48px;
      opacity: 0.2;
    }

    /* 滚动条样式 - 黑色主题 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 放大镜样式 */
    .magnifier {
      position: fixed;
      width: 200px;
      height: 200px;
      border: 3px solid #667eea;
      border-radius: 50%;
      pointer-events: none;
      display: none;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 9998;
    }

    .magnifier.visible {
      display: block;
    }

    .magnifier-image {
      position: absolute;
      transform-origin: top left;
    }

    /* EXIF信息面板 */
    .exif-panel {
      position: fixed;
      right: -320px;
      top: 0;
      bottom: 0;
      width: 320px;
      background: rgba(20, 20, 20, 0.98);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      padding: 20px;
    }

    .exif-panel.visible {
      right: 0;
    }

    .exif-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .exif-panel-header h3 {
      color: #e0e0e0;
      font-size: 16px;
      font-weight: 600;
    }

    .exif-close {
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .exif-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .exif-section {
      margin-bottom: 20px;
    }

    .exif-section-title {
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .exif-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .exif-item:last-child {
      border-bottom: none;
    }

    .exif-label {
      color: #888;
      font-size: 13px;
    }

    .exif-value {
      color: #e0e0e0;
      font-size: 13px;
      font-weight: 500;
      text-align: right;
    }

    .exif-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .exif-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .exif-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    /* 批量选择模式 */
    .batch-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .batch-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .batch-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .thumbnail-checkbox {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 18px;
      height: 18px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }

    .thumbnail-checkbox.visible {
      display: flex;
    }

    .thumbnail-checkbox.checked {
      background: #667eea;
      border-color: #667eea;
    }

    .thumbnail-checkbox i {
      color: white;
      font-size: 12px;
    }

    /* 废片标记 - 评级栏背景变红 */
    .thumbnail-rating.rejected {
      background: rgba(224, 23, 23, 0.726) !important;
    }

    .thumbnail-rating.rejected .thumbnail-star {
      color: rgba(255, 255, 255, 0.5) !important;
    }

    .thumbnail-rating.rejected .thumbnail-star.active {
      color: white !important;
    }

    /* 删除按钮 */
    .delete-button {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .delete-button:hover:not(.disabled) {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .delete-button.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* 删除确认对话框 */
    .delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .delete-modal.visible {
      display: flex;
    }

    .delete-modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .delete-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .delete-modal-header i {
      font-size: 24px;
      color: #ef4444;
    }

    .delete-modal-header h3 {
      color: #e0e0e0;
      font-size: 18px;
      font-weight: 600;
    }

    .delete-modal-body {
      color: #888;
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .delete-modal-body strong {
      color: #ef4444;
    }

    .delete-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .delete-option {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .delete-option:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .delete-option i {
      font-size: 18px;
      color: #ef4444;
    }

    .delete-option-text {
      color: #e0e0e0;
      font-size: 14px;
    }

    .delete-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .delete-modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-modal-btn.cancel {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #888;
    }

    .delete-modal-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    /* 进度指示器 */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .progress-overlay.visible {
      display: flex;
    }

    .progress-container {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 30px 40px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .progress-title {
      color: #e0e0e0;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .progress-bar-container {
      width: 300px;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      color: #888;
      font-size: 13px;
    }

    /* 加载动画 */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .thumbnail-item {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .view-toggle-container {
      display: flex;
      gap: 4px;
      margin-right: 12px;
    }

    .view-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .view-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .view-btn.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .theme-selector {
      position: relative;
    }

    .theme-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .theme-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .theme-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: rgba(25, 25, 25, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px;
      min-width: 140px;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
    }

    .theme-dropdown.visible {
      display: block;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: #aaa;
      font-size: 13px;
    }

    .theme-option:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    .theme-option.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .theme-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .file-tooltip {
      position: fixed;
      background: rgba(25, 25, 25, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      color: #e0e0e0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      max-width: 280px;
    }

    .file-tooltip.visible {
      opacity: 1;
    }

    .file-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 6px;
    }

    .file-tooltip-row:last-child {
      margin-bottom: 0;
    }

    .file-tooltip-label {
      color: #888;
    }

    .file-tooltip-value {
      color: #e0e0e0;
      font-weight: 500;
    }

    .rating-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 6px;
      font-size: 12px;
      color: #888;
    }

    .rating-stats-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .rating-stats-item i {
      font-size: 12px;
      color: #667eea;
    }

    .rating-stats-divider {
      width: 1px;
      height: 14px;
      background: rgba(255, 255, 255, 0.1);
    }

    .list-view .thumbnail-container {
      height: auto;
      max-height: 300px;
      padding: 8px 20px;
    }

    .list-view .thumbnail-wrapper {
      display: flex;
      flex-direction: column;
      white-space: normal;
    }

    .list-view .thumbnail-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 8px;
    }

    .list-view .thumbnail-image-wrapper {
      width: 80px;
      height: 50px;
      flex-shrink: 0;
    }

    .list-view .thumbnail-rating {
      flex-direction: row;
      flex: 1;
      justify-content: flex-start;
      padding: 0 12px;
      background: transparent;
    }

    .list-view .thumbnail-format {
      position: static;
      margin-left: 8px;
    }

    .detail-view .thumbnail-container {
      height: auto;
      max-height: 400px;
    }

    .detail-view .thumbnail-item {
      width: 200px;
    }

    .detail-view .thumbnail-image-wrapper {
      width: 100%;
      height: 100px;
    }

    .detail-view .thumbnail-item::after {
      content: attr(data-filename);
      display: block;
      font-size: 10px;
      color: #888;
      text-align: center;
      padding: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    [data-theme="midnight"] body,
    [data-theme="midnight"] .container {
      background: #0a0a12;
    }

    [data-theme="midnight"] .title-bar,
    [data-theme="midnight"] .path-container,
    [data-theme="midnight"] .preview-container,
    [data-theme="midnight"] .thumbnail-container,
    [data-theme="midnight"] .toolbar {
      background: rgba(18, 18, 26, 0.98);
    }

    [data-theme="midnight"] .star.active,
    [data-theme="midnight"] .filter-star.active,
    [data-theme="midnight"] .thumbnail-star.active {
      color: #6366f1;
    }

    [data-theme="midnight"] .path-button,
    [data-theme="midnight"] .filter-btn.active,
    [data-theme="midnight"] .progress-bar {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    [data-theme="ocean"] body,
    [data-theme="ocean"] .container {
      background: #0a1015;
    }

    [data-theme="ocean"] .title-bar,
    [data-theme="ocean"] .path-container,
    [data-theme="ocean"] .preview-container,
    [data-theme="ocean"] .thumbnail-container,
    [data-theme="ocean"] .toolbar {
      background: rgba(16, 24, 32, 0.98);
    }

    [data-theme="ocean"] .star.active,
    [data-theme="ocean"] .filter-star.active,
    [data-theme="ocean"] .thumbnail-star.active {
      color: #0ea5e9;
    }

    [data-theme="ocean"] .path-button,
    [data-theme="ocean"] .filter-btn.active,
    [data-theme="ocean"] .progress-bar {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    }

    [data-theme="forest"] body,
    [data-theme="forest"] .container {
      background: #0a120d;
    }

    [data-theme="forest"] .title-bar,
    [data-theme="forest"] .path-container,
    [data-theme="forest"] .preview-container,
    [data-theme="forest"] .thumbnail-container,
    [data-theme="forest"] .toolbar {
      background: rgba(18, 26, 20, 0.98);
    }

    [data-theme="forest"] .star.active,
    [data-theme="forest"] .filter-star.active,
    [data-theme="forest"] .thumbnail-star.active {
      color: #22c55e;
    }

    [data-theme="forest"] .path-button,
    [data-theme="forest"] .filter-btn.active,
    [data-theme="forest"] .progress-bar {
      background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
    }

    [data-theme="sunset"] body,
    [data-theme="sunset"] .container {
      background: #120a0a;
    }

    [data-theme="sunset"] .title-bar,
    [data-theme="sunset"] .path-container,
    [data-theme="sunset"] .preview-container,
    [data-theme="sunset"] .thumbnail-container,
    [data-theme="sunset"] .toolbar {
      background: rgba(26, 18, 18, 0.98);
    }

    [data-theme="sunset"] .star.active,
    [data-theme="sunset"] .filter-star.active,
    [data-theme="sunset"] .thumbnail-star.active {
      color: #f97316;
    }

    [data-theme="sunset"] .path-button,
    [data-theme="sunset"] .filter-btn.active,
    [data-theme="sunset"] .progress-bar {
      background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
    }

    [data-theme="purple"] body,
    [data-theme="purple"] .container {
      background: #0f0a12;
    }

    [data-theme="purple"] .title-bar,
    [data-theme="purple"] .path-container,
    [data-theme="purple"] .preview-container,
    [data-theme="purple"] .thumbnail-container,
    [data-theme="purple"] .toolbar {
      background: rgba(22, 16, 26, 0.98);
    }

    [data-theme="purple"] .star.active,
    [data-theme="purple"] .filter-star.active,
    [data-theme="purple"] .thumbnail-star.active {
      color: #a855f7;
    }

    [data-theme="purple"] .path-button,
    [data-theme="purple"] .filter-btn.active,
    [data-theme="purple"] .progress-bar {
      background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
    }

    .progress-overlay {
      backdrop-filter: blur(8px);
    }

    .progress-container {
      min-width: 320px;
    }

    .progress-percentage {
      font-size: 24px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 8px;
    }

    .progress-detail {
      font-size: 12px;
      color: #888;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 标题栏 -->
    <div class="title-bar">
      <div class="window-title">
        <i class="ri-image-line"></i>
        QuickPick - 图片查看管理器
      </div>
      <div class="title-bar-center">
        <div class="title-bar-stats" id="titleBarStats">
          <span class="title-bar-stats-item"><i class="ri-star-fill"></i><span id="statsTotal">0</span></span>
          <span class="title-bar-stats-divider"></span>
          <span class="title-bar-stats-item" title="5星"><span>5:</span><span id="stats5">0</span></span>
          <span class="title-bar-stats-item" title="4星"><span>4:</span><span id="stats4">0</span></span>
          <span class="title-bar-stats-item" title="3星"><span>3:</span><span id="stats3">0</span></span>
          <span class="title-bar-stats-item" title="2星"><span>2:</span><span id="stats2">0</span></span>
          <span class="title-bar-stats-item" title="1星"><span>1:</span><span id="stats1">0</span></span>
        </div>
        <button class="title-bar-help" id="helpButton" title="快捷键帮助"><i class="ri-keyboard-line"></i></button>
      </div>
      <div class="window-controls">
        <button class="control-button minimize"><i class="ri-subtract-line"></i></button>
        <button class="control-button maximize"><i class="ri-checkbox-blank-line"></i></button>
        <button class="control-button close"><i class="ri-close-line"></i></button>
      </div>
    </div>
    <!-- 顶部路径管理模块 -->
    <div class="path-container">
      <div class="path-item">
        <span class="path-label"><i class="ri-image-2-line"></i>JPG路径</span>
        <input type="text" class="path-input" id="jpgPath" placeholder="请输入JPG文件路径">
        <button class="path-button" id="jpgBrowse"><i class="ri-folder-open-line"></i>浏览</button>
      </div>
      <div class="path-item">
        <span class="path-label"><i class="ri-camera-line"></i>RAW路径</span>
        <input type="text" class="path-input" id="rawPath" placeholder="请输入RAW文件路径">
        <button class="path-button" id="rawBrowse"><i class="ri-folder-open-line"></i>浏览</button>
      </div>
      <button class="path-button" id="loadButton" style="white-space: nowrap;"><i class="ri-refresh-line"></i>加载图片</button>
    </div>

    <!-- 中间预览区域 -->
    <div class="preview-container">
      <div class="preview-wrapper" id="previewWrapper">
        <div class="no-image" id="noImage">
          <i class="ri-image-add-line"></i>
          <span></span>
        </div>
      </div>
      <div class="rating-container" id="ratingContainer">
        <div class="batch-info-inline" id="batchInfoInline" style="display: none;">
          <span>已选择 <strong id="batchCountInline">0</strong> 张</span>
          <button class="batch-cancel-inline" id="batchCancelInline" title="取消选择"><i class="ri-close-line"></i></button>
        </div>
        <div class="rating-stars">
          <span class="star" data-rating="1"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="2"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="3"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="4"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="5"><i class="ri-star-fill"></i></span>
        </div>
      </div>
    </div>

    <!-- 底部缩略图区域 -->
    <div class="thumbnail-resize-handle" id="thumbnailResizeHandle"></div>
    <div class="thumbnail-container" id="thumbnailContainer">
      <div class="thumbnail-wrapper" id="thumbnailWrapper">
      </div>
    </div>

    <!-- 操作栏 -->
    <div class="toolbar">
      <div class="filter-container">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all" title="全部">
            <i class="ri-apps-line"></i>
          </button>
          <button class="filter-btn" data-filter="any" title="有星">
            <i class="ri-star-fill"></i>
          </button>
          <button class="filter-btn" data-filter="none" title="无星">
            <i class="ri-star-line"></i>
          </button>
          <button class="filter-btn" data-filter="equal" title="等于">
            <i class="ri-equal-line"></i>
          </button>
          <button class="filter-btn" data-filter="greater" title="大于等于">
            <i class="ri-arrow-up-circle-line"></i>
          </button>
          <button class="filter-btn" data-filter="less" title="小于等于">
            <i class="ri-arrow-down-circle-line"></i>
          </button>
        </div>
        <div class="filter-stars" id="filterStars">
          <span class="filter-star" data-rating="1"><i class="ri-star-fill"></i></span>
          <span class="filter-star" data-rating="2"><i class="ri-star-fill"></i></span>
          <span class="filter-star" data-rating="3"><i class="ri-star-fill"></i></span>
          <span class="filter-star" data-rating="4"><i class="ri-star-fill"></i></span>
          <span class="filter-star" data-rating="5"><i class="ri-star-fill"></i></span>
        </div>
        <span class="filter-status" id="filterStatus">未筛选</span>
      </div>
      <div class="view-toggle-container">
        <button class="view-btn active" data-view="grid" title="网格视图">
          <i class="ri-grid-line"></i>
        </button>
        <button class="view-btn" data-view="detail" title="详情视图">
          <i class="ri-gallery-line"></i>
        </button>
      </div>
      <!-- <div class="theme-selector">
        <button class="theme-btn" id="themeBtn" title="主题选择">
          <i class="ri-palette-line"></i>
        </button>
        <div class="theme-dropdown" id="themeDropdown">
          <div class="theme-option active" data-theme="default">
            <div class="theme-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
            <span>默认紫</span>
          </div>
          <div class="theme-option" data-theme="midnight">
            <div class="theme-color" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);"></div>
            <span>午夜蓝</span>
          </div>
          <div class="theme-option" data-theme="ocean">
            <div class="theme-color" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4);"></div>
            <span>海洋青</span>
          </div>
          <div class="theme-option" data-theme="forest">
            <div class="theme-color" style="background: linear-gradient(135deg, #22c55e, #10b981);"></div>
            <span>森林绿</span>
          </div>
          <div class="theme-option" data-theme="sunset">
            <div class="theme-color" style="background: linear-gradient(135deg, #f97316, #ef4444);"></div>
            <span>日落橙</span>
          </div>
          <div class="theme-option" data-theme="purple">
            <div class="theme-color" style="background: linear-gradient(135deg, #a855f7, #d946ef);"></div>
            <span>魅惑紫</span>
          </div>
        </div>
      </div> -->
      <button class="batch-toggle" id="batchToggle" title="批量选择">
        <i class="ri-checkbox-multiple-line"></i>
      </button>
      <button class="exif-toggle" id="exifToggle" title="EXIF信息">
        <i class="ri-file-info-line"></i>
      </button>
      <button class="magnifier-toggle" id="magnifierToggle" title="放大镜 (默认关闭)">
        <i class="ri-search-eye-line"></i>
      </button>
      <button class="export-button" id="exportButton"><i class="ri-download-2-line"></i>导出文件</button>
      <button class="delete-button disabled" id="deleteButton" disabled><i class="ri-delete-bin-line"></i>删除废片</button>
    </div>

    <!-- 删除确认对话框 -->
    <div class="delete-modal" id="deleteModal">
      <div class="delete-modal-content">
        <div class="delete-modal-header">
          <i class="ri-error-warning-line"></i>
          <h3>确认删除</h3>
        </div>
        <div class="delete-modal-body">
          您已标记 <strong id="rejectedCount">0</strong> 张废片，请选择删除方式：
        </div>
        <div class="delete-options">
          <div class="delete-option" id="deleteBoth">
            <i class="ri-file-copy-line"></i>
            <span class="delete-option-text">删除 JPG 和 RAW 文件</span>
          </div>
          <div class="delete-option" id="deleteJpg">
            <i class="ri-image-line"></i>
            <span class="delete-option-text">仅删除 JPG 文件</span>
          </div>
          <div class="delete-option" id="deleteRaw">
            <i class="ri-file-unknow-line"></i>
            <span class="delete-option-text">仅删除 RAW 文件</span>
          </div>
        </div>
        <div class="delete-modal-footer">
          <button class="delete-modal-btn cancel" id="deleteCancel">取消</button>
        </div>
      </div>
    </div>

    <!-- EXIF信息面板 -->
    <div class="exif-panel" id="exifPanel">
      <div class="exif-panel-header">
        <h3>EXIF 信息</h3>
        <button class="exif-close" id="exifClose"><i class="ri-close-line"></i></button>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">相机信息</div>
        <div class="exif-item">
          <span class="exif-label">相机型号</span>
          <span class="exif-value" id="exifCamera">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">镜头型号</span>
          <span class="exif-value" id="exifLens">-</span>
        </div>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">拍摄参数</div>
        <div class="exif-item">
          <span class="exif-label">光圈</span>
          <span class="exif-value" id="exifAperture">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">快门速度</span>
          <span class="exif-value" id="exifShutter">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">ISO</span>
          <span class="exif-value" id="exifISO">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">焦距</span>
          <span class="exif-value" id="exifFocalLength">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">曝光补偿</span>
          <span class="exif-value" id="exifExposureBias">-</span>
        </div>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">图片信息</div>
        <div class="exif-item">
          <span class="exif-label">分辨率</span>
          <span class="exif-value" id="exifResolution">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">拍摄时间</span>
          <span class="exif-value" id="exifDateTime">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">文件大小</span>
          <span class="exif-value" id="exifFileSize">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">文件名</span>
          <span class="exif-value" id="exifFileName">-</span>
        </div>
      </div>
    </div>

    <!-- 文件信息悬浮提示 -->
    <div class="file-tooltip" id="fileTooltip">
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">文件名</span>
        <span class="file-tooltip-value" id="tooltipFileName">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">文件大小</span>
        <span class="file-tooltip-value" id="tooltipFileSize">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">分辨率</span>
        <span class="file-tooltip-value" id="tooltipResolution">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">评级</span>
        <span class="file-tooltip-value" id="tooltipRating">-</span>
      </div>
    </div>

    <!-- 进度指示器 -->
    <div class="progress-overlay" id="progressOverlay">
      <div class="progress-container">
        <div class="progress-percentage" id="progressPercentage">0%</div>
        <div class="progress-title" id="progressTitle">加载中...</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar" style="width: 0%"></div>
        </div>
        <div class="progress-text" id="progressText">0 / 0</div>
        <div class="progress-detail" id="progressDetail"></div>
      </div>
    </div>

    <!-- 快捷键帮助弹窗 -->
    <div class="help-modal" id="helpModal">
      <div class="help-modal-content">
        <div class="help-modal-header">
          <h3>键盘快捷键</h3>
          <button class="help-close" id="helpClose"><i class="ri-close-line"></i></button>
        </div>
        <div class="help-modal-body">
          <div class="help-section">
            <h4>导航</h4>
            <div class="help-item"><span class="key">←</span><span class="key">→</span> 切换图片</div>
            <div class="help-item"><span class="key">Home</span> 第一张图片</div>
            <div class="help-item"><span class="key">End</span> 最后一张图片</div>
          </div>
          <div class="help-section">
            <h4>评级</h4>
            <div class="help-item"><span class="key">1-5</span> 设置1-5星</div>
            <div class="help-item"><span class="key">0</span> 取消评级</div>
            <div class="help-item"><span class="key">Space</span> 切换标记</div>
            <div class="help-item"><span class="key">Delete</span> 标记为废片</div>
          </div>
          <div class="help-section">
            <h4>缩放</h4>
            <div class="help-item"><span class="key">+</span> 放大</div>
            <div class="help-item"><span class="key">-</span> 缩小</div>
            <div class="help-item"><span class="key">Esc</span> 重置缩放</div>
          </div>
          <div class="help-section">
            <h4>其他</h4>
            <div class="help-item"><span class="key">F</span> 全屏模式</div>
            <div class="help-item"><span class="key">Ctrl+E</span> 导出文件</div>
            <div class="help-item"><span class="key">Ctrl+A</span> 全选缩略图</div>
            <div class="help-item"><span class="key">Esc</span> 退出批量模式</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 放大镜 -->
    <div class="magnifier" id="magnifier">
      <img class="magnifier-image" id="magnifierImage" alt="">
    </div>
  </div>

  <script>
    let jpgPath = '';
    let rawPath = '';
    let imageGroups = [];
    let filteredGroups = [];
    let currentIndex = 0;
    let ratingsData = {};
    let filterCondition = 'all';
    let filterRating = 0;
    let isDragging = false;
    let mouseOffsetX = 0;
    let mouseOffsetY = 0;
    let currentScale = 1;
    let offsetX = 0;
    let offsetY = 0;

    function joinPath(...parts) {
      return parts.join('/').replace(/\/+/g, '/');
    }

    const RAW_EXTENSIONS = ['.cr2', '.cr3', '.arw', '.nef', '.dng', '.raw'];

    function isRawFile(path) {
      const ext = path.toLowerCase();
      return RAW_EXTENSIONS.some(e => ext.endsWith(e));
    }

    let currentLoadingId = 0;

    const MAX_IMAGE_CACHE = 100;
    const MAX_THUMBNAIL_CACHE = 200;



    class LRUCache {
      constructor(maxSize) {
        this.maxSize = maxSize;
        this.cache = new Map();
        this.order = [];
      }
      
      get(key) {
        if (this.cache.has(key)) {
          this.updateOrder(key);
          return this.cache.get(key);
        }
        return null;
      }
      
      set(key, value) {
        if (this.cache.has(key)) {
          this.updateOrder(key);
        } else {
          this.order.push(key);
        }
        this.cache.set(key, value);
        this.evict();
      }
      
      updateOrder(key) {
        const index = this.order.indexOf(key);
        if (index !== -1) {
          this.order.splice(index, 1);
          this.order.push(key);
        }
      }
      
      evict() {
        while (this.cache.size > this.maxSize && this.order.length > 0) {
          const oldestKey = this.order.shift();
          this.cache.delete(oldestKey);
        }
      }
      
      clear() {
        this.cache.clear();
        this.order = [];
      }
      
      get size() {
        return this.cache.size;
      }
    }
    
    const previewCache = new LRUCache(MAX_IMAGE_CACHE);
    const thumbnailLRUCache = new LRUCache(MAX_THUMBNAIL_CACHE);

    let currentView = 'grid';
    let currentTheme = 'default';
    let tooltipTimeout = null;

    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      loadRatingsData();
      initMagnifier();
      initExifPanel();
      initBatchMode();
      initThumbnailResize();
      initViewToggle();
      // initThemeSelector();
      initFileTooltip();
    });

    // 初始化事件监听器
    function initEventListeners() {
      // 恢复文本选择功能
      document.body.style.userSelect = 'auto';
      document.body.style.webkitUserSelect = 'auto';
      document.body.style.msUserSelect = 'auto';
      
      // 窗口控制按钮
      document.querySelector('.control-button.minimize').addEventListener('click', () => {
        window.electronAPI.window.minimize();
      });
      
      document.querySelector('.control-button.maximize').addEventListener('click', () => {
        window.electronAPI.window.maximize();
      });
      
      document.querySelector('.control-button.close').addEventListener('click', () => {
        window.electronAPI.window.close();
      });
      
      // 路径管理
      document.getElementById('jpgBrowse').addEventListener('click', () => browseDirectory('jpg'));
      document.getElementById('rawBrowse').addEventListener('click', () => browseDirectory('raw'));
      document.getElementById('loadButton').addEventListener('click', loadImages);
      document.getElementById('jpgPath').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadImages();
      });
      document.getElementById('rawPath').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadImages();
      });

      // 星级评级
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          setRating(rating);
        });
      });

      // 筛选
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          setFilterCondition(filter);
        });
      });
      document.querySelectorAll('.filter-star').forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          setFilterRating(rating);
        });
      });

      // 导出
      document.getElementById('exportButton').addEventListener('click', exportFiles);

      // 删除废片
      document.getElementById('deleteButton').addEventListener('click', showDeleteModal);
      document.getElementById('deleteCancel').addEventListener('click', hideDeleteModal);
      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          hideDeleteModal();
        }
      });
      document.getElementById('deleteBoth').addEventListener('click', () => deleteRejectedFiles('both'));
      document.getElementById('deleteJpg').addEventListener('click', () => deleteRejectedFiles('jpg'));
      document.getElementById('deleteRaw').addEventListener('click', () => deleteRejectedFiles('raw'));

      // 快捷键帮助
      document.getElementById('helpButton').addEventListener('click', () => {
        document.getElementById('helpModal').classList.add('visible');
      });

      document.getElementById('helpClose').addEventListener('click', () => {
        document.getElementById('helpModal').classList.remove('visible');
      });

      document.getElementById('helpModal').addEventListener('click', (e) => {
        if (e.target.id === 'helpModal') {
          document.getElementById('helpModal').classList.remove('visible');
        }
      });

      // 键盘快捷键
      document.addEventListener('keydown', (e) => {
        // 如果焦点在输入框中，不处理快捷键
        if (e.target.tagName === 'INPUT') return;
        
        // Ctrl组合键
        if (e.ctrlKey || e.metaKey) {
          switch (e.key.toLowerCase()) {
            case 'e':
              e.preventDefault();
              exportFiles();
              break;
            case 'a':
              e.preventDefault();
              selectAllThumbnails();
              break;
          }
          return;
        }
        
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            // 防止按住方向键时连续翻页
            if (!e.repeat) {
              navigateImage(-1);
            }
            break;
          case 'ArrowRight':
            e.preventDefault();
            // 防止按住方向键时连续翻页
            if (!e.repeat) {
              navigateImage(1);
            }
            break;
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
            e.preventDefault();
            setRating(parseInt(e.key));
            break;
          case '0':
            e.preventDefault();
            setRating(0);
            break;
          case '+':
          case '=':
            e.preventDefault();
            scaleImage(1.2);
            break;
          case '-':
            e.preventDefault();
            scaleImage(0.8);
            break;
          case 'f':
            e.preventDefault();
            toggleFullscreen();
            break;
          case 'Delete':
          case 'Backspace':
            e.preventDefault();
            toggleRejected();
            break;
          case ' ':
            e.preventDefault();
            toggleMark();
            break;
          case 'Home':
            e.preventDefault();
            showImage(0);
            break;
          case 'End':
            e.preventDefault();
            showImage(filteredGroups.length - 1);
            break;
          case 'Escape':
            e.preventDefault();
            if (batchMode) {
              toggleBatchMode();
            } else {
              resetZoom();
            }
            break;
        }
      });

      // 鼠标滚轮缩放
      document.getElementById('previewWrapper').addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scaleImage(delta, e.clientX, e.clientY);
      });

      // 拖拽移动 - 使用左键拖拽，同时禁用文本选择
      const previewWrapper = document.getElementById('previewWrapper');
      
      // 监听鼠标按下事件，响应左键
      previewWrapper.addEventListener('mousedown', (e) => {
        // 检查是否是左键
        if (e.button === 0 && e.target.classList.contains('preview-image')) {
          // 禁用文本选择
          e.preventDefault();
          startDrag(e);
        }
      });
      
      // 监听鼠标移动事件
      document.addEventListener('mousemove', (e) => {
        // 如果正在拖拽，禁用文本选择
        if (isDragging) {
          e.preventDefault();
        }
        drag(e);
      });
      
      // 监听鼠标释放事件
      document.addEventListener('mouseup', (e) => {
        // 检查是否是左键
        if (e.button === 0) {
          endDrag();
        }
      });
      
      // 添加鼠标移出窗口时的处理，确保拖拽状态能够正确结束
      document.addEventListener('mouseleave', endDrag);
      previewWrapper.addEventListener('mouseleave', endDrag);
      
      // 缩略图横向滚动功能
      const thumbnailContainer = document.getElementById('thumbnailContainer');
      thumbnailContainer.addEventListener('wheel', (e) => {
        e.preventDefault();
        thumbnailContainer.scrollLeft += e.deltaY;
      }, { passive: false });
      
      // 批量模式下双击预览图选中/取消选中
      previewWrapper.addEventListener('dblclick', (e) => {
        if (!batchMode) return;
        const img = e.target.closest('.preview-image');
        if (img) {
          toggleThumbnailSelection(currentIndex);
        }
      });
    }

    // 浏览目录
    async function browseDirectory(type) {
      try {
        const path = await window.electronAPI.openDirectoryDialog({});
        if (path) {
          document.getElementById(`${type}Path`).value = path;
          // 自动加载图片
          loadImages();
        }
      } catch (error) {
        console.error('浏览目录失败:', error);
      }
    }

    // 加载图片
    async function loadImages() {
      try {
        // 获取路径
        const jpgInput = document.getElementById('jpgPath').value;
        const rawInput = document.getElementById('rawPath').value;

        // 验证路径
        if (jpgInput) {
          const jpgExists = await window.electronAPI.fs.existsSync(jpgInput);
          if (!jpgExists) {
            showMessage('错误', 'JPG路径不存在', 'error');
            return;
          }
          jpgPath = jpgInput;
        }

        if (rawInput) {
          const rawExists = await window.electronAPI.fs.existsSync(rawInput);
          if (!rawExists) {
            showMessage('错误', 'RAW路径不存在', 'error');
            return;
          }
          rawPath = rawInput;
        }

        // 扫描文件
        await scanFiles();
      } catch (error) {
        console.error('加载图片失败:', error);
        showMessage('错误', '操作失败', 'error');
      }
    }

    // 扫描文件
    async function scanFiles() {
      try {
        const jpgFiles = [];
        const rawFiles = [];

        // 扫描JPG文件
        if (jpgPath) {
          const files = await window.electronAPI.fs.readdir(jpgPath);
          jpgFiles.push(...files.filter(file => {
            const ext = file.toLowerCase();
            return ext.endsWith('.jpg') || ext.endsWith('.jpeg');
          }).map(file => ({ path: joinPath(jpgPath, file), name: file, type: 'jpg' })));
        }

        // 扫描RAW文件
        if (rawPath) {
          const files = await window.electronAPI.fs.readdir(rawPath);
          rawFiles.push(...files.filter(file => {
            return isRawFile(file);
          }).map(file => ({ path: joinPath(rawPath, file), name: file, type: 'raw' })));
        }

        // 生成图片组
        generateImageGroups(jpgFiles, rawFiles);

        // 加载星级数据
        await loadRatingsData();

        // 应用筛选
        applyFilter();

        // 显示第一张图片
        if (filteredGroups.length > 0) {
          showImage(0);
        } else {
          showNoImage();
        }
      } catch (error) {
        console.error('扫描文件失败:', error);
        showMessage('错误', '扫描文件失败', 'error');
      }
    }

    // 生成图片组
    function generateImageGroups(jpgFiles, rawFiles) {
      const groups = {};

      // 添加JPG文件
      jpgFiles.forEach(file => {
        const prefix = getFilePrefix(file.name);
        if (!groups[prefix]) {
          groups[prefix] = { jpg: null, raw: null };
        }
        groups[prefix].jpg = file;
      });

      // 添加RAW文件
      rawFiles.forEach(file => {
        const prefix = getFilePrefix(file.name);
        if (!groups[prefix]) {
          groups[prefix] = { jpg: null, raw: null };
        }
        groups[prefix].raw = file;
      });

      // 转换为数组并排序
      imageGroups = Object.values(groups).filter(group => group.jpg || group.raw);
      imageGroups.sort((a, b) => {
        const nameA = (a.jpg || a.raw).name;
        const nameB = (b.jpg || b.raw).name;
        return nameA.localeCompare(nameB);
      });
    }

    // 获取文件前缀
    function getFilePrefix(filename) {
      return filename.replace(/\.[^/.]+$/, '');
    }

    // 应用筛选
    function applyFilter() {
      filteredGroups = imageGroups.filter(group => {
        const file = group.jpg || group.raw;
        const fileName = file.name;
        const rating = ratingsData[fileName]?.rating || 0;

        switch (filterCondition) {
          case 'all':
            return true;
          case 'equal':
            return rating === filterRating;
          case 'greater':
            return rating >= filterRating;
          case 'less':
            return rating <= filterRating;
          case 'none':
            return rating === 0;
          case 'any':
            return rating > 0;
          default:
            return true;
        }
      });

      updateThumbnails(filteredGroups);
      updateFilterStatus();
      updateRatingStats();

      if (filteredGroups.length > 0) {
        showImage(0);
      } else {
        showNoImage();
      }
    }

    // 更新缩略图 - 使用虚拟滚动和懒加载优化
    function updateThumbnails(groups) {
      const wrapper = document.getElementById('thumbnailWrapper');
      wrapper.innerHTML = '';

      const fragment = document.createDocumentFragment();

      groups.forEach((group, index) => {
        const thumbnailFile = group.jpg || group.raw;
        if (!thumbnailFile) return;

        const fileName = thumbnailFile.name;
        const rating = ratingsData[fileName]?.rating || 0;
        
        let ratingStars = '';
        for (let i = 1; i <= 5; i++) {
          const isActive = i <= rating ? 'active' : '';
          ratingStars += `<span class="thumbnail-star ${isActive}" data-rating="${i}" data-index="${index}"><i class="ri-star-fill"></i></span>`;
        }

        const thumbnailItem = document.createElement('div');
        thumbnailItem.className = 'thumbnail-item';
        thumbnailItem.dataset.index = index;
        thumbnailItem.dataset.filename = fileName;

        let formatLabels = '';
        if (group.jpg && group.raw) {
          formatLabels = `
            <div class="thumbnail-format jpg">JPG</div>
            <div class="thumbnail-format raw">RAW</div>
          `;
        } else {
          formatLabels = `
            <div class="thumbnail-format ${thumbnailFile.type}">${thumbnailFile.type.toUpperCase()}</div>
          `;
        }

        thumbnailItem.innerHTML = `
          <div class="thumbnail-checkbox" data-index="${index}">
            <i class="ri-check-line"></i>
          </div>
          <div class="thumbnail-image-wrapper">
            <img class="thumbnail-image lazy" data-src="${thumbnailFile.path}" alt="${thumbnailFile.name}" loading="lazy">
            <div class="thumbnail-overlay"></div>
            ${formatLabels}
          </div>
          <div class="thumbnail-rating ${rejectedImages.has(fileName) ? 'rejected' : ''}">${ratingStars}</div>
        `;

        thumbnailItem.addEventListener('click', handleThumbnailClick);
        thumbnailItem.addEventListener('contextmenu', handleThumbnailRightClick);

        const checkbox = thumbnailItem.querySelector('.thumbnail-checkbox');
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleThumbnailSelection(index);
        });

        fragment.appendChild(thumbnailItem);
      });

      wrapper.appendChild(fragment);

      // 更新复选框状态
      updateThumbnailCheckboxes();

      // 更新当前选中的缩略图状态
      updateThumbnailSelection(currentIndex);

      // 使用Intersection Observer实现懒加载
      setupLazyLoading();
    }

    // 缩略图点击事件处理
    function handleThumbnailClick(e) {
      const thumbnailItem = e.currentTarget;
      const index = parseInt(thumbnailItem.dataset.index);
      
      // 如果点击的是星级，不切换图片
      if (e.target.closest('.thumbnail-star')) {
        const star = e.target.closest('.thumbnail-star');
        const starRating = parseInt(star.dataset.rating);
        setThumbnailRating(index, starRating);
      } else {
        showImage(index);
      }
    }

    // 缩略图右键点击事件处理
    function handleThumbnailRightClick(e) {
      e.preventDefault();
      
      // 只在批量模式下处理右键点击
      if (!batchMode) return;
      
      const thumbnailItem = e.currentTarget;
      const index = parseInt(thumbnailItem.dataset.index);
      
      toggleThumbnailSelection(index);
    }

    function setupLazyLoading() {
      const lazyImages = document.querySelectorAll('.thumbnail-image.lazy');
      
      if ('IntersectionObserver' in window) {
        const imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              loadThumbnailImage(img);
              observer.unobserve(img);
            }
          });
        }, {
          rootMargin: '100px',
          threshold: 0.01
        });

        lazyImages.forEach(img => {
          imageObserver.observe(img);
        });
      } else {
        lazyImages.forEach(img => {
          loadThumbnailImage(img);
        });
      }
    }
    
    async function loadThumbnailImage(img) {
      const filePath = img.dataset.src;
      if (!filePath) return;
      
      const cachedThumbnail = thumbnailLRUCache.get(filePath);
      if (cachedThumbnail) {
        img.src = cachedThumbnail;
        img.classList.remove('lazy');
        return;
      }

      if (isRawFile(filePath)) {
        try {
          const result = await window.electronAPI.image.getThumbnail(filePath, 240);
          if (result.data) {
            const dataUrl = `data:image/jpeg;base64,${result.data}`;
            thumbnailLRUCache.set(filePath, dataUrl);
            img.src = dataUrl;
            img.classList.remove('lazy');
            return;
          }
        } catch (e) {
          console.error('加载RAW缩略图失败:', e);
        }
      }
      
      img.src = filePath;
      img.classList.remove('lazy');
      thumbnailLRUCache.set(filePath, filePath);
    }

    async function setThumbnailRating(index, rating) {
      const group = filteredGroups[index];
      if (!group) return;

      if (group.jpg) {
        updateRating(group.jpg.path, rating);
        window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[group.jpg.name].rating);
      }
      if (group.raw) {
        updateRating(group.raw.path, rating);
        window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[group.raw.name].rating);
      }

      const actualRating = ratingsData[group.jpg?.name || group.raw?.name]?.rating || 0;

      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (thumbnailItem) {
        const stars = thumbnailItem.querySelectorAll('.thumbnail-star');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating);
          star.classList.toggle('active', starRating <= actualRating);
        });
      }
      
      if (currentIndex === index) {
        updateRatingDisplay(group.jpg?.path || group.raw?.path);
      }
    }

    function showImage(index) {
      if (index < 0 || index >= filteredGroups.length) return;

      currentIndex = index;
      const group = filteredGroups[index];

      const displayFile = group.jpg || group.raw;
      if (!displayFile) return;

      const previewWrapper = document.getElementById('previewWrapper');
      previewWrapper.innerHTML = '';

      const loadingId = ++currentLoadingId;

      const showProgressiveImage = async () => {
        const isRaw = isRawFile(displayFile.path);

        let lowQualitySrc = null;
        let highQualitySrc = null;
        
        const img = document.createElement('img');
        img.className = 'preview-image';
        img.alt = displayFile.name;
        
        const cachedPreview = previewCache.get(displayFile.path);
        if (cachedPreview) {
          highQualitySrc = cachedPreview;
        } else {
          if (isRaw) {
            try {
              const previewResult = await window.electronAPI.image.getPreview(displayFile.path);
              if (previewResult.data && loadingId === currentLoadingId) {
                lowQualitySrc = `data:image/jpeg;base64,${previewResult.data}`;
              }
            } catch (e) {
              console.error('获取RAW预览失败:', e);
            }
          }
          
          highQualitySrc = displayFile.path;
        }
        
        if (loadingId !== currentLoadingId) return;
        
        if (lowQualitySrc) {
          img.src = lowQualitySrc;
          img.style.filter = 'blur(2px)';
          img.style.transition = 'filter 0.3s ease';
          previewWrapper.appendChild(img);
          
          currentScale = 1;
          offsetX = 0;
          offsetY = 0;
          updateImageTransform(img);
          
          const highQualityImg = new Image();
          highQualityImg.onload = () => {
            if (loadingId !== currentLoadingId) return;
            img.src = highQualitySrc;
            img.style.filter = 'none';
            previewCache.set(displayFile.path, highQualitySrc);
          };
          highQualityImg.src = highQualitySrc;
        } else {
          img.src = highQualitySrc || displayFile.path;
          previewWrapper.appendChild(img);
          
          currentScale = 1;
          offsetX = 0;
          offsetY = 0;
          updateImageTransform(img);
          
          if (!cachedPreview) {
            previewCache.set(displayFile.path, displayFile.path);
          }
        }
        
        updateRatingDisplay(displayFile.path);
        
        if (exifPanelVisible) {
          updateExifDisplay();
        }
        
        updateThumbnailSelection(index);
      };
      
      showProgressiveImage();
    }

    // 显示无图片提示
    function showNoImage() {
      const previewWrapper = document.getElementById('previewWrapper');
      previewWrapper.innerHTML = '<div class="no-image">无图片可显示</div>';
      updateRatingDisplay(null);
    }

    // 更新图片变换
    function updateImageTransform(img) {
      if (!img) return;
      img.style.transform = `scale(${currentScale}) translate(${offsetX}px, ${offsetY}px)`;
    }

    // 限制图片在视窗内
    function constrainImagePosition() {
      const img = document.querySelector('.preview-image');
      if (!img) return;

      const wrapper = document.getElementById('previewWrapper');
      const wrapperRect = wrapper.getBoundingClientRect();
      
      // 获取图片的自然尺寸
      const imgNaturalWidth = img.naturalWidth;
      const imgNaturalHeight = img.naturalHeight;
      
      // 计算缩放后的图片尺寸
      const imgWidth = imgNaturalWidth * currentScale;
      const imgHeight = imgNaturalHeight * currentScale;

      // 限制水平位置 - previewWrapper的边界就是图片拖动的边界
      if (imgWidth > wrapperRect.width) {
        const maxOffsetX = (imgWidth - wrapperRect.width) / 2;
        offsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, offsetX));
      } else {
        // 图片宽度小于等于预览区宽度时，居中显示
        offsetX = 0;
      }

      // 限制垂直位置 - previewWrapper的边界就是图片拖动的边界
      if (imgHeight > wrapperRect.height) {
        const maxOffsetY = (imgHeight - wrapperRect.height) / 2;
        offsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, offsetY));
      } else {
        // 图片高度小于等于预览区高度时，居中显示
        offsetY = 0;
      }

      updateImageTransform(img);
    }

    // 缩放图片
    function scaleImage(factor, x, y) {
      const img = document.querySelector('.preview-image');
      if (!img) return;

      const newScale = Math.max(1, currentScale * factor);
      currentScale = newScale;

      offsetX = 0;
      offsetY = 0;

      updateImageTransform(img);
      setTimeout(constrainImagePosition, 10);
    }

    // 开始拖拽
    function startDrag(e) {
      // 禁用浏览器默认行为
      e.preventDefault();
      e.stopPropagation();
      
      if (e.target.classList.contains('preview-image')) {
        isDragging = true;

        const img = e.target;
        const imgRect = img.getBoundingClientRect();
        const wrapper = document.getElementById('previewWrapper');
        const wrapperRect = wrapper.getBoundingClientRect();
        
        // 计算图片的实际位置（考虑缩放和偏移）
        const imgNaturalWidth = img.naturalWidth;
        const imgNaturalHeight = img.naturalHeight;
        const imgWidth = imgNaturalWidth * currentScale;
        const imgHeight = imgNaturalHeight * currentScale;
        
        // 计算图片在预览区中的实际位置
        const imgLeft = wrapperRect.left + (wrapperRect.width - imgWidth) / 2 + offsetX * currentScale;
        const imgTop = wrapperRect.top + (wrapperRect.height - imgHeight) / 2 + offsetY * currentScale;
        
        // 计算鼠标在图片上的相对位置（相对于图片左上角）
        mouseOffsetX = e.clientX - imgLeft;
        mouseOffsetY = e.clientY - imgTop;
      }
    }

    // 拖拽中
    function drag(e) {
      if (!isDragging) return;
      // 禁用浏览器默认行为
      e.preventDefault();
      e.stopPropagation();
      
      const img = document.querySelector('.preview-image');
      if (!img) return;
      
      const wrapper = document.getElementById('previewWrapper');
      const wrapperRect = wrapper.getBoundingClientRect();
      
      // 获取图片的自然尺寸
      const imgNaturalWidth = img.naturalWidth;
      const imgNaturalHeight = img.naturalHeight;
      
      // 计算缩放后的图片尺寸
      const imgWidth = imgNaturalWidth * currentScale;
      const imgHeight = imgNaturalHeight * currentScale;
      
      // 计算图片在预览区中的理想位置，使鼠标始终锁定在落点
      // 目标：鼠标位置 = 图片左上角位置 + 鼠标在图片上的相对位置
      const targetImgLeft = e.clientX - mouseOffsetX;
      const targetImgTop = e.clientY - mouseOffsetY;
      
      // 计算图片在预览区中的理想偏移量
      // 预览区中心位置
      const wrapperCenterX = wrapperRect.left + wrapperRect.width / 2;
      const wrapperCenterY = wrapperRect.top + wrapperRect.height / 2;
      
      // 图片中心位置
      const imgCenterX = targetImgLeft + imgWidth / 2;
      const imgCenterY = targetImgTop + imgHeight / 2;
      
      // 计算偏移量（相对于预览区中心）
      const newOffsetX = (imgCenterX - wrapperCenterX) / currentScale;
      const newOffsetY = (imgCenterY - wrapperCenterY) / currentScale;
      
      // Windows 11照片浏览器风格的拖拽逻辑
      // 如果图片宽度没有超出视窗宽度，则不允许水平拖拽
      let constrainedOffsetX = offsetX;
      if (imgWidth > wrapperRect.width) {
        const maxOffsetX = (imgWidth - wrapperRect.width) / 2;
        constrainedOffsetX = Math.max(-maxOffsetX, Math.min(maxOffsetX, newOffsetX));
      } else {
        // 图片宽度没有超出，保持居中
        constrainedOffsetX = 0;
      }
      
      // 如果图片高度没有超出视窗高度，则不允许垂直拖拽
      let constrainedOffsetY = offsetY;
      if (imgHeight > wrapperRect.height) {
        const maxOffsetY = (imgHeight - wrapperRect.height) / 2;
        constrainedOffsetY = Math.max(-maxOffsetY, Math.min(maxOffsetY, newOffsetY));
      } else {
        // 图片高度没有超出，保持居中
        constrainedOffsetY = 0;
      }
      
      // 强制更新偏移量
      offsetX = constrainedOffsetX;
      offsetY = constrainedOffsetY;
      
      // 强制更新图片位置
      img.style.transform = `scale(${currentScale}) translate(${offsetX}px, ${offsetY}px)`;
    }

    // 结束拖拽
    function endDrag() {
      isDragging = false;
      // 拖拽结束后立即限制图片在视窗内
      setTimeout(() => {
        constrainImagePosition();
      }, 0);
    }

    // 导航图片
    function navigateImage(direction) {
      const newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < filteredGroups.length) {
        showImage(newIndex);
      }
    }

    // 放大镜功能
    let magnifierEnabled = false; // 默认关闭
    const magnifier = document.getElementById('magnifier');
    const magnifierImage = document.getElementById('magnifierImage');
    const magnifierZoom = 2.5; // 放大倍数

    function initMagnifier() {
      const previewWrapper = document.getElementById('previewWrapper');
      
      previewWrapper.addEventListener('mousemove', (e) => {
        if (!magnifierEnabled) return;
        
        const img = document.querySelector('.preview-image');
        if (!img || e.target !== img) {
          hideMagnifier();
          return;
        }
        
        showMagnifier(e, img);
      });
      
      previewWrapper.addEventListener('mouseleave', hideMagnifier);
      
      // 放大镜开关按钮
      const magnifierToggle = document.getElementById('magnifierToggle');
      magnifierToggle.addEventListener('click', () => {
        magnifierEnabled = !magnifierEnabled;
        magnifierToggle.classList.toggle('active', magnifierEnabled);
        magnifierToggle.title = magnifierEnabled ? '放大镜 (已开启)' : '放大镜 (默认关闭)';
        if (!magnifierEnabled) {
          hideMagnifier();
        }
      });
    }

    function showMagnifier(e, img) {
      const imgRect = img.getBoundingClientRect();
      
      // 检查鼠标是否在图片上
      if (e.clientX < imgRect.left || e.clientX > imgRect.right ||
          e.clientY < imgRect.top || e.clientY > imgRect.bottom) {
        hideMagnifier();
        return;
      }
      
      // 设置放大镜图片源
      if (magnifierImage.src !== img.src) {
        magnifierImage.src = img.src;
      }
      
      // 计算放大后的尺寸
      const zoomedWidth = imgRect.width * magnifierZoom;
      const zoomedHeight = imgRect.height * magnifierZoom;
      
      magnifierImage.style.width = zoomedWidth + 'px';
      magnifierImage.style.height = zoomedHeight + 'px';
      
      // 计算鼠标在图片上的位置
      const mouseX = e.clientX - imgRect.left;
      const mouseY = e.clientY - imgRect.top;
      
      // 计算放大镜图片的位置（使鼠标位置居中）
      const magnifierX = -mouseX * magnifierZoom + 100;
      const magnifierY = -mouseY * magnifierZoom + 100;
      
      magnifierImage.style.left = magnifierX + 'px';
      magnifierImage.style.top = magnifierY + 'px';
      
      // 设置放大镜位置
      magnifier.style.left = (e.clientX - 100) + 'px';
      magnifier.style.top = (e.clientY - 100) + 'px';
      
      magnifier.classList.add('visible');
    }

    function hideMagnifier() {
      magnifier.classList.remove('visible');
    }



    // 重置缩放
    function resetZoom() {
      currentScale = 1;
      offsetX = 0;
      offsetY = 0;
      
      const img = document.querySelector('.preview-image');
      if (img) {
        img.style.transform = `scale(1) translate(0px, 0px)`;
      }
    }

    // 切换全屏
    function toggleFullscreen() {
      const previewWrapper = document.getElementById('previewWrapper');
      if (!document.fullscreenElement) {
        previewWrapper.requestFullscreen().catch(err => {
          console.log('无法进入全屏模式:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // 标记为废片
    // function markAsRejected() {
    //   const group = filteredGroups[currentIndex];
    //   if (!group) return;
      
    //   // 设置为0星表示废片
    //   setRating(0);
    // }

    // 切换标记
    function toggleMark() {
      const group = filteredGroups[currentIndex];
      if (!group) return;
      
      const fileName = group.jpg?.name || group.raw?.name;
      const currentRating = ratingsData[fileName]?.rating || 0;
      
      // 如果有星级则取消，否则设为1星
      if (currentRating > 0) {
        setRating(0);
      } else {
        setRating(1);
      }
    }

    // 全选缩略图
    function selectAllThumbnails() {
      if (!batchMode) {
        toggleBatchMode();
      }
      selectedThumbnails = new Set(filteredGroups.map((_, i) => i));
      updateThumbnailCheckboxes();
      updateBatchCount();
    }

    // 批量选择模式
    let batchMode = false;
    let selectedThumbnails = new Set();

    // 废片标记
    let rejectedImages = new Set();

    function initBatchMode() {
      const batchToggle = document.getElementById('batchToggle');
      const batchCancelInline = document.getElementById('batchCancelInline');

      batchToggle.addEventListener('click', toggleBatchMode);
      batchCancelInline.addEventListener('click', clearBatchSelection);
    }

    function toggleBatchMode() {
      batchMode = !batchMode;
      const batchToggle = document.getElementById('batchToggle');
      const batchInfoInline = document.getElementById('batchInfoInline');
      
      batchToggle.classList.toggle('active', batchMode);
      
      if (batchMode) {
        batchInfoInline.style.display = 'flex';
      } else {
        batchInfoInline.style.display = 'none';
        selectedThumbnails.clear();
      }
      
      updateThumbnailCheckboxes();
      updateBatchCount();
    }

    function clearBatchSelection() {
      selectedThumbnails.clear();
      updateThumbnailCheckboxes();
      updateBatchCount();
    }

    function updateThumbnailCheckboxes() {
      document.querySelectorAll('.thumbnail-checkbox').forEach(checkbox => {
        checkbox.classList.toggle('visible', batchMode);
        const index = parseInt(checkbox.dataset.index);
        checkbox.classList.toggle('checked', selectedThumbnails.has(index));
      });
    }

    function updateBatchCount() {
      document.getElementById('batchCountInline').textContent = selectedThumbnails.size;
    }

    function toggleThumbnailSelection(index) {
      if (selectedThumbnails.has(index)) {
        selectedThumbnails.delete(index);
      } else {
        selectedThumbnails.add(index);
      }
      updateThumbnailCheckboxes();
      updateBatchCount();
    }

    // 废片标记功能
    function toggleRejected() {
      const group = filteredGroups[currentIndex];
      if (!group) return;

      const file = group.jpg || group.raw;
      if (!file) return;

      const fileName = file.name;
      
      if (rejectedImages.has(fileName)) {
        rejectedImages.delete(fileName);
      } else {
        rejectedImages.add(fileName);
      }

      updateRejectedBadge(currentIndex);
      updateDeleteButton();
    }

    function updateRejectedBadge(index) {
      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (!thumbnailItem) return;

      const group = filteredGroups[index];
      if (!group) return;

      const file = group.jpg || group.raw;
      if (!file) return;

      const fileName = file.name;
      const isRejected = rejectedImages.has(fileName);

      const ratingDiv = thumbnailItem.querySelector('.thumbnail-rating');
      if (ratingDiv) {
        if (isRejected) {
          ratingDiv.classList.add('rejected');
        } else {
          ratingDiv.classList.remove('rejected');
        }
      }
    }

    function updateDeleteButton() {
      const deleteBtn = document.getElementById('deleteButton');
      if (rejectedImages.size > 0) {
        deleteBtn.disabled = false;
        deleteBtn.classList.remove('disabled');
      } else {
        deleteBtn.disabled = true;
        deleteBtn.classList.add('disabled');
      }
    }

    // 删除对话框
    function showDeleteModal() {
      if (rejectedImages.size === 0) return;
      document.getElementById('rejectedCount').textContent = rejectedImages.size;
      document.getElementById('deleteModal').classList.add('visible');
    }

    function hideDeleteModal() {
      document.getElementById('deleteModal').classList.remove('visible');
    }

    async function deleteRejectedFiles(mode) {
      hideDeleteModal();
      
      const filesToDelete = [];
      
      for (const fileName of rejectedImages) {
        const group = imageGroups.find(g => 
          (g.jpg && g.jpg.name === fileName) || 
          (g.raw && g.raw.name === fileName)
        );
        
        if (!group) continue;
        
        if (mode === 'both') {
          if (group.jpg) filesToDelete.push(group.jpg.path);
          if (group.raw) filesToDelete.push(group.raw.path);
        } else if (mode === 'jpg' && group.jpg) {
          filesToDelete.push(group.jpg.path);
        } else if (mode === 'raw' && group.raw) {
          filesToDelete.push(group.raw.path);
        }
      }

      if (filesToDelete.length === 0) {
        showMessage('提示', '没有可删除的文件', 'info');
        return;
      }

      showProgress('删除文件...');
      let deleted = 0;

      for (const filePath of filesToDelete) {
        try {
          await window.electronAPI.fs.deleteFile(filePath);
          deleted++;
          updateProgress(deleted, filesToDelete.length);
        } catch (error) {
          console.error(`删除文件失败: ${filePath}`, error);
        }
      }

      hideProgress();
      
      // 清空废片标记
      rejectedImages.clear();
      updateDeleteButton();
      
      // 重新加载图片
      await loadImages();
      
      showMessage('删除完成', `已删除 ${deleted} 个文件`, 'info');
    }

    async function batchSetRating(rating) {
      if (selectedThumbnails.size === 0) {
        showMessage('提示', '请先选择图片', 'info');
        return;
      }

      showProgress('批量设置评级...');
      let processed = 0;
      const total = selectedThumbnails.size;

      for (const index of selectedThumbnails) {
        const group = filteredGroups[index];
        if (!group) continue;

        if (group.jpg) {
          updateRating(group.jpg.path, rating);
          window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[group.jpg.name].rating);
        }
        if (group.raw) {
          updateRating(group.raw.path, rating);
          window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[group.raw.name].rating);
        }

        processed++;
        updateProgress(processed, total);
      }

      hideProgress();
      updateThumbnails(filteredGroups);
      // showMessage('完成', `已为 ${processed} 张图片设置评级`, 'info');
    }

    // EXIF信息面板
    let exifPanelVisible = false;

    function initExifPanel() {
      const exifToggle = document.getElementById('exifToggle');
      const exifPanel = document.getElementById('exifPanel');
      const exifClose = document.getElementById('exifClose');

      exifToggle.addEventListener('click', () => {
        exifPanelVisible = !exifPanelVisible;
        exifPanel.classList.toggle('visible', exifPanelVisible);
        exifToggle.classList.toggle('active', exifPanelVisible);
        
        if (exifPanelVisible) {
          updateExifDisplay();
        }
      });

      exifClose.addEventListener('click', () => {
        exifPanelVisible = false;
        exifPanel.classList.remove('visible');
        exifToggle.classList.remove('active');
      });
    }

    async function updateExifDisplay() {
      const group = filteredGroups[currentIndex];
      if (!group) {
        clearExifDisplay();
        return;
      }

      const file = group.jpg || group.raw;
      if (!file) return;

      try {
        const metadata = await window.electronAPI.image.readMetadata(file.path);
        if (metadata) {
          displayExifData(metadata, file);
        } else {
          clearExifDisplay();
        }
      } catch (error) {
        console.error('读取EXIF信息失败:', error);
        clearExifDisplay();
      }
    }

    function displayExifData(metadata, file) {
      // 相机信息
      const camera = metadata.Make || metadata.Model || metadata['Model'] || metadata['Make'];
      document.getElementById('exifCamera').textContent = camera ? camera.description : '-';

      const lens = metadata.LensModel || metadata.Lens || metadata['LensModel'];
      document.getElementById('exifLens').textContent = lens ? lens.description : '-';

      // 拍摄参数
      const aperture = metadata.FNumber || metadata.ApertureValue || metadata['FNumber'];
      document.getElementById('exifAperture').textContent = aperture ? `f/${aperture.description}` : '-';

      const shutter = metadata.ExposureTime || metadata.ShutterSpeedValue || metadata['ExposureTime'];
      document.getElementById('exifShutter').textContent = shutter ? formatShutter(shutter.description) : '-';

      const iso = metadata.ISO || metadata.ISOSpeedRatings || metadata['ISOSpeedRatings'];
      document.getElementById('exifISO').textContent = iso ? iso.description : '-';

      const focalLength = metadata.FocalLength || metadata['FocalLength'];
      document.getElementById('exifFocalLength').textContent = focalLength ? `${focalLength.description}mm` : '-';

      const exposureBias = metadata.ExposureBiasValue || metadata['ExposureBiasValue'];
      document.getElementById('exifExposureBias').textContent = exposureBias ? `${exposureBias.description} EV` : '-';

      // 图片信息
      const width = metadata['Image Width'] || metadata.PixelXDimension || metadata['PixelXDimension'];
      const height = metadata['Image Height'] || metadata.PixelYDimension || metadata['PixelYDimension'];
      document.getElementById('exifResolution').textContent = width && height ? `${width.description} × ${height.description}` : '-';

      const dateTime = metadata.DateTime || metadata.CreateDate || metadata['DateTimeOriginal'];
      document.getElementById('exifDateTime').textContent = dateTime ? formatDateTime(dateTime.description) : '-';

      // 文件大小 - 通过IPC获取
      window.electronAPI.fs.stat(file.path).then(stats => {
        const fileSizeMB = (stats.size / (1024 * 1024)).toFixed(2);
        document.getElementById('exifFileSize').textContent = `${fileSizeMB} MB`;
      }).catch(() => {
        document.getElementById('exifFileSize').textContent = '-';
      });

      document.getElementById('exifFileName').textContent = file.name || '-';
    }

    function clearExifDisplay() {
      document.getElementById('exifCamera').textContent = '-';
      document.getElementById('exifLens').textContent = '-';
      document.getElementById('exifAperture').textContent = '-';
      document.getElementById('exifShutter').textContent = '-';
      document.getElementById('exifISO').textContent = '-';
      document.getElementById('exifFocalLength').textContent = '-';
      document.getElementById('exifExposureBias').textContent = '-';
      document.getElementById('exifResolution').textContent = '-';
      document.getElementById('exifDateTime').textContent = '-';
      document.getElementById('exifFileSize').textContent = '-';
      document.getElementById('exifFileName').textContent = '-';
    }

    function formatShutter(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return value;
      if (num >= 1) return `${num}s`;
      return `1/${Math.round(1 / num)}s`;
    }

    function formatDateTime(value) {
      if (!value) return '-';
      // EXIF日期格式: YYYY:MM:DD HH:mm:ss
      const match = value.match(/(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
      if (match) {
        return `${match[1]}-${match[2]}-${match[3]} ${match[4]}:${match[5]}:${match[6]}`;
      }
      return value;
    }



    // 更新星级显示
    function updateRatingDisplay(filePath) {
      const stars = document.querySelectorAll('.star');
      const fileName = filePath ? filePath.split(/[/\\]/).pop() : '';
      const rating = fileName ? (ratingsData[fileName]?.rating || 0) : 0;

      stars.forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= rating);
      });
    }

    // 设置星级
    async function setRating(rating) {
      // 如果在批量模式下，调用批量评级
      if (batchMode && selectedThumbnails.size > 0) {
        await batchSetRating(rating);
        return;
      }

      const group = filteredGroups[currentIndex];
      if (!group) return;

      if (group.jpg) {
        updateRating(group.jpg.path, rating);
        window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[group.jpg.name].rating);
      }
      if (group.raw) {
        updateRating(group.raw.path, rating);
        window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[group.raw.name].rating);
      }

      updateRatingDisplay(group.jpg?.path || group.raw?.path);
      
      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${currentIndex}"]`);
      if (thumbnailItem) {
        const actualRating = ratingsData[group.jpg?.name || group.raw?.name]?.rating || 0;
        const stars = thumbnailItem.querySelectorAll('.thumbnail-star');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating);
          star.classList.toggle('active', starRating <= actualRating);
        });
      }
    }

    // 更新星级数据
    function updateRating(filePath, rating) {
      // 使用文件名作为键
      const fileName = filePath.split(/[/\\]/).pop();
      if (!ratingsData[fileName]) {
        ratingsData[fileName] = { rating: 0, tags: [] };
      }

      // 如果点击的是当前星级，则取消评级
      if (ratingsData[fileName].rating === rating) {
        ratingsData[fileName].rating = 0;
      } else {
        ratingsData[fileName].rating = rating;
      }
    }

    // 更新缩略图选中状态
    function updateThumbnailSelection(index) {
      document.querySelectorAll('.thumbnail-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        // 滚动到可见区域
        scrollThumbnailIntoView(activeItem);
      }
    }

    // 滚动缩略图到可见区域
    function scrollThumbnailIntoView(thumbnailItem) {
      const container = document.getElementById('thumbnailContainer');
      const itemRect = thumbnailItem.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      // 计算缩略图相对于容器的位置
      const itemLeft = itemRect.left - containerRect.left;
      const itemRight = itemRect.right - containerRect.left;
      const itemWidth = itemRect.width;
      
      // 检查是否在可见区域内
      const isFullyVisible = itemLeft >= 0 && itemRight <= containerRect.width;
      
      if (isFullyVisible) return;
      
      // 判断缩略图在左侧还是右侧
      if (itemLeft < 0) {
        // 缩略图在左侧，滚动到左侧对齐
        container.scrollTo({
          left: thumbnailItem.offsetLeft - 10,
          behavior: 'instant'
        });
      } else if (itemRight > containerRect.width) {
        // 缩略图在右侧，滚动到右侧对齐
        container.scrollTo({
          left: thumbnailItem.offsetLeft - containerRect.width + itemWidth + 10,
          behavior: 'instant'
        });
      }
    }

    // 更新筛选状态
    function updateFilterStatus() {
      const statusElement = document.getElementById('filterStatus');
      let statusText = '未筛选';

      if (filterCondition !== 'all') {
        switch (filterCondition) {
          case 'equal':
            statusText = `已筛选：=${filterRating}星`;
            break;
          case 'greater':
            statusText = `已筛选：≥${filterRating}星`;
            break;
          case 'less':
            statusText = `已筛选：≤${filterRating}星`;
            break;
          case 'none':
            statusText = '已筛选：无星';
            break;
          case 'any':
            statusText = '已筛选：有星';
            break;
        }
      }

      statusElement.textContent = statusText;
    }

    // 设置筛选条件
    function setFilterCondition(filter) {
      filterCondition = filter;
      
      // 更新按钮状态
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      
      // 控制星级筛选区域的显示
      const filterStars = document.getElementById('filterStars');
      const needStars = ['equal', 'greater', 'less'].includes(filter);
      filterStars.classList.toggle('visible', needStars);
      
      // 如果不需要星级筛选，重置星级
      if (!needStars) {
        filterRating = 0;
        document.querySelectorAll('.filter-star').forEach(star => {
          star.classList.remove('active');
        });
      }
      
      applyFilter();
    }

    // 设置筛选星级
    function setFilterRating(rating) {
      // 如果点击的是当前星级，则取消筛选
      if (filterRating === rating) {
        filterRating = 0;
      } else {
        filterRating = rating;
      }

      // 更新筛选星级显示，点亮逻辑与评分一致
      document.querySelectorAll('.filter-star').forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= filterRating);
      });

      applyFilter();
    }

    // 导出文件
    async function exportFiles() {
      try {
        // 选择导出目录
        const exportPath = await window.electronAPI.openDirectoryDialog({
          title: '选择导出目录',
          defaultPath: ''
        });

        if (!exportPath) return;

        // 统计需要导出的文件
        const filesToExport = [];
        for (const group of imageGroups) {
          const file = group.jpg || group.raw;
          const fileName = file.name;
          const rating = ratingsData[fileName]?.rating || 0;
          
          if (rating > 0) {
            filesToExport.push({ group, rating });
          }
        }

        if (filesToExport.length === 0) {
          showMessage('提示', '没有需要导出的文件', 'info');
          return;
        }

        // 显示进度指示器
        showProgress('导出文件...');
        
        let jpgCount = 0;
        let rawCount = 0;
        let processedCount = 0;

        // 遍历需要导出的文件
        for (const { group, rating } of filesToExport) {
          // 4星及以下：仅导出JPG
          if (rating <= 4 && group.jpg) {
            const targetPath = joinPath(exportPath, 'JPG_Export', group.jpg.name);
            await window.electronAPI.fs.copyFile(group.jpg.path, targetPath);
            jpgCount++;
          }
          // 5星：导出JPG和RAW
          else if (rating === 5) {
            if (group.jpg) {
              const targetPath = joinPath(exportPath, 'JPG_Export', group.jpg.name);
              await window.electronAPI.fs.copyFile(group.jpg.path, targetPath);
              jpgCount++;
            }
            if (group.raw) {
              const targetPath = joinPath(exportPath, 'RAW_Export', group.raw.name);
              await window.electronAPI.fs.copyFile(group.raw.path, targetPath);
              rawCount++;
            }
          }
          
          processedCount++;
          updateProgress(processedCount, filesToExport.length, `导出: ${processedCount} / ${filesToExport.length}`);
        }

        hideProgress();
        showMessage('导出完成', `导出完成：${jpgCount}个JPG文件，${rawCount}个RAW文件`, 'info');
      } catch (error) {
        console.error('导出文件失败:', error);
        hideProgress();
        showMessage('错误', '导出文件失败', 'error');
      }
    }

    // 加载星级数据 - 使用批量并发处理优化性能
    async function loadRatingsData() {
      try {
        // 初始化ratingsData对象
        ratingsData = {};
        
        // 批量并发读取评级数据，每批处理20个文件
        const batchSize = 20;
        const allFiles = [];
        
        // 收集所有需要读取评级的文件
        for (const group of imageGroups) {
          if (group.jpg) {
            allFiles.push({ file: group.jpg, type: 'jpg' });
          }
          if (group.raw) {
            allFiles.push({ file: group.raw, type: 'raw' });
          }
        }
        
        // 显示进度指示器
        if (allFiles.length > 50) {
          showProgress('加载评级数据...');
        }
        
        const totalFiles = allFiles.length;
        let processedFiles = 0;
        
        // 分批处理
        for (let i = 0; i < allFiles.length; i += batchSize) {
          const batch = allFiles.slice(i, i + batchSize);
          
          // 并发读取当前批次的评级
          const ratings = await Promise.all(
            batch.map(async ({ file }) => {
              try {
                const rating = await window.electronAPI.image.readRating(file.path);
                return { fileName: file.name, rating };
              } catch (error) {
                console.error(`读取文件 ${file.name} 评级失败:`, error);
                return { fileName: file.name, rating: 0 };
              }
            })
          );
          
          // 存储评级数据
          ratings.forEach(({ fileName, rating }) => {
            ratingsData[fileName] = { rating, tags: [] };
          });
          
          // 更新进度
          processedFiles += batch.length;
          if (allFiles.length > 50) {
            updateProgress(processedFiles, totalFiles);
          }
        }
        
        // 隐藏进度指示器
        hideProgress();
      } catch (error) {
        console.error('加载星级数据失败:', error);
        ratingsData = {};
        hideProgress();
      }
    }


    function showMessage(title, message, type) {
      window.electronAPI.showMessageBox({
        title: title,
        message: message,
        type: type
      });
    }

    function initThumbnailResize() {
      const handle = document.getElementById('thumbnailResizeHandle');
      const container = document.getElementById('thumbnailContainer');
      
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;
      
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = container.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const deltaY = startY - e.clientY;
        const newHeight = Math.max(80, Math.min(400, startHeight + deltaY));
        container.style.height = newHeight + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }

    function initViewToggle() {
      const viewBtns = document.querySelectorAll('.view-btn');
      
      viewBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const view = btn.dataset.view;
          setView(view);
        });
      });
    }
    
    function setView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      const container = document.querySelector('.container');
      container.classList.remove('list-view', 'detail-view');
      
      if (view === 'detail') {
        container.classList.add('detail-view');
      }
      
      updateThumbnails(filteredGroups);
    }

    // function initThemeSelector() {
    //   // const themeBtn = document.getElementById('themeBtn');
    //   const themeDropdown = document.getElementById('themeDropdown');
      
    //   // themeBtn.addEventListener('click', (e) => {
    //   //   e.stopPropagation();
    //   //   themeDropdown.classList.toggle('visible');
    //   // });
      
    //   document.addEventListener('click', () => {
    //     themeDropdown.classList.remove('visible');
    //   });
      
    //   themeDropdown.addEventListener('click', (e) => {
    //     e.stopPropagation();
    //   });
      
    //   document.querySelectorAll('.theme-option').forEach(option => {
    //     option.addEventListener('click', () => {
    //       const theme = option.dataset.theme;
    //       setTheme(theme);
    //       themeDropdown.classList.remove('visible');
    //     });
    //   });
    // }
    
    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === theme);
      });
    }

    function initFileTooltip() {
      const tooltip = document.getElementById('fileTooltip');
      
      document.addEventListener('mouseover', async (e) => {
        const thumbnailItem = e.target.closest('.thumbnail-item');
        if (!thumbnailItem) {
          hideFileTooltip();
          return;
        }
        
        const index = parseInt(thumbnailItem.dataset.index);
        const group = filteredGroups[index];
        if (!group) return;
        
        const file = group.jpg || group.raw;
        if (!file) return;
        
        tooltipTimeout = setTimeout(() => {
          showFileTooltip(e, file, group);
        }, 500);
      });
      
      document.addEventListener('mouseout', (e) => {
        if (e.target.closest('.thumbnail-item')) {
          clearTimeout(tooltipTimeout);
          hideFileTooltip();
        }
      });
      
      document.addEventListener('mousemove', (e) => {
        if (tooltip.classList.contains('visible')) {
          positionTooltip(e);
        }
      });
    }
    
    async function showFileTooltip(e, file, group) {
      const tooltip = document.getElementById('fileTooltip');
      
      document.getElementById('tooltipFileName').textContent = file.name;
      
      const rating = ratingsData[file.name]?.rating || 0;
      document.getElementById('tooltipRating').textContent = rating > 0 ? `${rating}星` : '未评级';
      
      try {
        const stats = await window.electronAPI.fs.stat(file.path);
        const sizeMB = (stats.size / (1024 * 1024)).toFixed(2);
        document.getElementById('tooltipFileSize').textContent = `${sizeMB} MB`;
      } catch (err) {
        document.getElementById('tooltipFileSize').textContent = '-';
      }
      
      try {
        const metadata = await window.electronAPI.image.readMetadata(file.path);
        if (metadata) {
          const width = metadata['Image Width'] || metadata.PixelXDimension;
          const height = metadata['Image Height'] || metadata.PixelYDimension;
          if (width && height) {
            document.getElementById('tooltipResolution').textContent = 
              `${width.description || width} × ${height.description || height}`;
          } else {
            document.getElementById('tooltipResolution').textContent = '-';
          }
        } else {
          document.getElementById('tooltipResolution').textContent = '-';
        }
      } catch (err) {
        document.getElementById('tooltipResolution').textContent = '-';
      }
      
      positionTooltip(e);
      tooltip.classList.add('visible');
    }
    
    function hideFileTooltip() {
      const tooltip = document.getElementById('fileTooltip');
      tooltip.classList.remove('visible');
    }
    
    function positionTooltip(e) {
      const tooltip = document.getElementById('fileTooltip');
      const padding = 15;
      
      let x = e.clientX + padding;
      let y = e.clientY + padding;
      
      const rect = tooltip.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      if (x + rect.width > windowWidth - padding) {
        x = e.clientX - rect.width - padding;
      }
      
      if (y + rect.height > windowHeight - padding) {
        y = e.clientY - rect.height - padding;
      }
      
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    function updateRatingStats() {
      const stats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
      
      imageGroups.forEach(group => {
        const file = group.jpg || group.raw;
        if (file) {
          const rating = ratingsData[file.name]?.rating || 0;
          stats[rating]++;
        }
      });
      
      document.getElementById('statsTotal').textContent = imageGroups.length;
      document.getElementById('stats5').textContent = stats[5];
      document.getElementById('stats4').textContent = stats[4];
      document.getElementById('stats3').textContent = stats[3];
      document.getElementById('stats2').textContent = stats[2];
      document.getElementById('stats1').textContent = stats[1];
    }

    function showProgress(title) {
      const overlay = document.getElementById('progressOverlay');
      document.getElementById('progressTitle').textContent = title || '处理中...';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressPercentage').textContent = '0%';
      document.getElementById('progressText').textContent = '0 / 0';
      document.getElementById('progressDetail').textContent = '';
      overlay.classList.add('visible');
    }

    function hideProgress() {
      const overlay = document.getElementById('progressOverlay');
      overlay.classList.remove('visible');
    }

    function updateProgress(current, total, text, detail) {
      const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressPercentage').textContent = percentage + '%';
      document.getElementById('progressText').textContent = text || `${current} / ${total}`;
      if (detail) {
        document.getElementById('progressDetail').textContent = detail;
      }
    }


  </script>
</body>
</html>