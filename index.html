<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickPick2 - 图片查看管理器</title>
  <link rel="stylesheet" href="./assets/remixicon.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: #0a0a0a;
      overflow: hidden;
    }

    /* 标题栏 - 黑色主题 */
    .title-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 20px;
      background: rgba(20, 20, 20, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      flex-shrink: 0;
      -webkit-app-region: drag;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .window-title {
      font-weight: 600;
      font-size: 13px;
      color: #e0e0e0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .window-title i {
      font-size: 16px;
      color: #667eea;
    }

    .title-bar-center {
      display: flex;
      align-items: center;
      gap: 12px;
      -webkit-app-region: no-drag;
    }

    .title-bar-stats {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 4px;
      font-size: 11px;
      color: #888;
    }

    .title-bar-stats-item {
      display: flex;
      align-items: center;
      gap: 2px;
      padding: 2px 4px;
      border-radius: 3px;
      transition: all 0.15s;
    }

    .title-bar-stats-item.clickable {
      cursor: pointer;
    }

    .title-bar-stats-item.clickable:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #b8b8b8;
    }

    .title-bar-stats-item.clickable.active {
      background: rgba(102, 126, 234, 0.25);
      color: #667eea;
    }

    .title-bar-stats-item.clickable.active i {
      color: #667eea;
    }

    .title-bar-stats-item i {
      font-size: 10px;
      color: #667eea;
    }

    .title-bar-stats-divider {
      width: 1px;
      height: 12px;
      background: rgba(255, 255, 255, 0.1);
      margin: 0 2px;
    }

    .title-bar-help {
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      transition: all 0.2s;
    }

    .title-bar-help:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    /* 非阻塞进度条 - 标题栏下方 */
    .header-progress {
      height: 3px;
      background: transparent;
      position: relative;
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .header-progress.visible {
      opacity: 1;
    }

    .header-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.2s ease;
      border-radius: 0 2px 2px 0;
    }

    .header-progress-text {
      position: absolute;
      left: 20px;
      top: 6px;
      font-size: 11px;
      color: #888;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .header-progress.visible .header-progress-text {
      opacity: 1;
    }

    .header-progress-bar.complete {
      animation: progressComplete 0.6s ease;
    }

    @keyframes progressComplete {
      0% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
      }
      50% {
        box-shadow: 0 0 20px 5px rgba(102, 126, 234, 0.8);
        filter: brightness(1.3);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
      }
    }

    /* 全局禁止选取（输入框除外） */
    * {
      user-select: none;
      -webkit-user-select: none;
    }

    input, textarea {
      user-select: text;
      -webkit-user-select: text;
    }

    /* 窗口控制按钮 - 黑色主题 */
    .window-controls {
      display: flex;
      gap: 4px;
      -webkit-app-region: no-drag;
    }

    .control-button {
      width: 40px;
      height: 28px;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: transparent;
      color: #888;
    }

    .control-button:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    .control-button.close:hover {
      background: #e81123;
      color: white;
    }

    .control-button:active {
      transform: scale(0.95);
    }

    /* 主容器 */
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      background: #0a0a0a;
    }

    /* 顶部路径管理模块 - 黑色主题 */
    .path-container {
      display: flex;
      padding: 10px 20px;
      background: rgba(18, 18, 18, 0.98);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      gap: 16px;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .path-item {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .path-label {
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
      color: #888;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .path-label i {
      font-size: 14px;
      color: #667eea;
    }

    .path-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      font-size: 12px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
    }

    .path-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    .path-button {
      padding: 8px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }

    .path-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    }

    .path-button:active {
      transform: translateY(0);
    }

    /* 中间预览区域 - 黑色主题 */
    .preview-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, #0d0d0d 0%, #1a1a1a 100%);
      position: relative;
      min-height: 200px;
    }

    .preview-wrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      position: relative;
    }

    .preview-image {
      max-width: 100%;
      max-height: 100%;
      cursor: grab;
      transition: transform 0.1s ease-out;
    }

    .preview-image:active {
      cursor: grabbing;
    }

    /* 星级评级控件 - 黑色主题 */
    .rating-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 16px;
      background: rgba(15, 15, 15, 0.95);
      backdrop-filter: blur(20px);
      color: white;
      gap: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .rating-stars {
      display: flex;
      gap: 5px;
    }

    .batch-info-inline {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(102, 126, 234, 0.15);
      border-radius: 4px;
      font-size: 12px;
      color: #667eea;
    }

    .batch-info-inline strong {
      font-weight: 600;
    }

    .batch-cancel-inline {
      background: none;
      border: none;
      color: #667eea;
      cursor: pointer;
      padding: 2px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .batch-cancel-inline:hover {
      color: #e0e0e0;
    }

    .star {
      font-size: 18px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.15);
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .star:hover {
      transform: scale(1.1);
    }

    .star.active,
    .star.hover-active {
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.4);
    }

    .star[data-rating="1"].active,
    .star[data-rating="1"].hover-active {
      color: #fef9c3;
    }

    .star[data-rating="2"].active,
    .star[data-rating="2"].hover-active {
      color: #fef3c7;
    }

    .star[data-rating="3"].active,
    .star[data-rating="3"].hover-active {
      color: #fde68a;
    }

    .star[data-rating="4"].active,
    .star[data-rating="4"].hover-active {
      color: #fcd34d;
    }

    .star[data-rating="5"].active,
    .star[data-rating="5"].hover-active {
      color: #fbbf24;
    }

    /* 底部缩略图区域 - 黑色主题 */
    .thumbnail-container {
      height: 122px;
      background: rgba(15, 15, 15, 0.98);
      backdrop-filter: blur(20px);
      padding: 12px 20px;
      overflow-x: auto;
      overflow-y: hidden;
      white-space: nowrap;
      flex-shrink: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.3);
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .thumbnail-wrapper {
      display: inline-flex;
      gap: 4px;
      align-items: flex-start;
    }

    .thumbnail-item {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      margin-right: 4px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 6px;
      /* transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
      overflow: visible;
      background: #2a2a2a;
    }

    .thumbnail-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }

    .thumbnail-item.active {
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
    }

    .thumbnail-item.selected {
      border-color: #22c55e;
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.3);
    }

    .thumbnail-image-wrapper {
      position: relative;
      width: 120px;
      height: 70px;
      background: #2a2a2a;
      border-radius: 4px 4px 0 0;
      overflow: hidden;
    }

    .thumbnail-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .thumbnail-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.045) 100%);
      border-radius: 4px 4px 0 0;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }

    .thumbnail-item:hover .thumbnail-overlay {
      opacity: 1;
    }

    .thumbnail-format {
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 9px;
      font-weight: 500;
      background: rgba(60, 60, 60, 0.9);
      color: #aaa;
    }

    .thumbnail-format.jpg {
      background: rgba(102, 126, 234, 0.3);
      color: #667eea;
    }

    .thumbnail-format.raw {
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .thumbnail-rating {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 3px;
      padding: 4px 0;
      background: #1a1a1a;
      border-radius: 0 0 4px 4px;
      flex-wrap: wrap;
    }

    .thumbnail-rating-formats {
      display: flex;
      gap: 2px;
      margin-right: 4px;
    }

    .thumbnail-star {
      font-size: 10px;
      cursor: pointer;
      color: #444;
      transition: all 0.1s ease;
    }

    .thumbnail-star:hover {
      transform: scale(1.15);
    }

    .thumbnail-star.active,
    .thumbnail-star.hover-active {
      text-shadow: 0 0 6px rgba(251, 191, 36, 0.4);
    }

    .thumbnail-star[data-rating="1"].active,
    .thumbnail-star[data-rating="1"].hover-active {
      color: #fef9c3;
    }

    .thumbnail-star[data-rating="2"].active,
    .thumbnail-star[data-rating="2"].hover-active {
      color: #fef3c7;
    }

    .thumbnail-star[data-rating="3"].active,
    .thumbnail-star[data-rating="3"].hover-active {
      color: #fde68a;
    }

    .thumbnail-star[data-rating="4"].active,
    .thumbnail-star[data-rating="4"].hover-active {
      color: #fcd34d;
    }

    .thumbnail-star[data-rating="5"].active,
    .thumbnail-star[data-rating="5"].hover-active {
      color: #fbbf24;
    }

    /* 操作栏 - 黑色主题 */
    .toolbar {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      background: rgba(18, 18, 18, 0.98);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255, 255, 255, 0.04);
      gap: 16px;
      flex-shrink: 0;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
    }

    .filter-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 4px;
    }

    .filter-btn {
      width: 36px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .filter-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 6px rgba(102, 126, 234, 0.25);
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      font-size: 13px;
      background: rgba(30, 30, 30, 0.9);
      color: #e0e0e0;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.15);
    }

    .filter-stars {
      display: flex;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .filter-star {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      color: rgba(255, 255, 255, 0.15);
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 4px 6px;
      border-radius: 4px;
    }

    .filter-star:hover {
      background: rgba(102, 126, 234, 0.1);
    }

    .filter-star:hover i {
      transform: scale(1.15);
    }

    .filter-star.active {
      background: rgba(102, 126, 234, 0.2);
    }

    .filter-star.active i,
    .filter-star.hover-active i {
      text-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
    }

    .filter-star i {
      font-size: 16px;
      transition: transform 0.15s;
    }

    .filter-star-count {
      font-size: 10px;
      color: #666;
      font-weight: 500;
    }

    .filter-star.active .filter-star-count {
      color: #667eea;
    }

    .filter-star[data-rating="1"].active i,
    .filter-star[data-rating="1"].hover-active i {
      color: #fef9c3;
    }

    .filter-star[data-rating="2"].active i,
    .filter-star[data-rating="2"].hover-active i {
      color: #fef3c7;
    }

    .filter-star[data-rating="3"].active i,
    .filter-star[data-rating="3"].hover-active i {
      color: #fde68a;
    }

    .filter-star[data-rating="4"].active i,
    .filter-star[data-rating="4"].hover-active i {
      color: #fcd34d;
    }

    .filter-star[data-rating="5"].active i,
    .filter-star[data-rating="5"].hover-active i {
      color: #fbbf24;
    }

    .filter-status {
      margin-left: 12px;
      font-size: 13px;
      color: #666;
      font-weight: 500;
    }

    .export-button {
      margin-left: auto;
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }

    .export-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35);
    }

    .export-button:active {
      transform: translateY(0);
    }

    .help-button {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .help-button:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .magnifier-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .magnifier-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .magnifier-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    /* 快捷键帮助弹窗 */
    .help-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }

    .help-modal.visible {
      display: flex;
    }

    .help-modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .help-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .help-modal-header h3 {
      color: #e0e0e0;
      font-size: 18px;
      font-weight: 600;
    }

    .help-close {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .help-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .help-modal-body {
      padding: 24px;
    }

    .help-section {
      margin-bottom: 24px;
    }

    .help-section:last-child {
      margin-bottom: 0;
    }

    .help-section h4 {
      color: #667eea;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .help-item {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      color: #aaa;
      font-size: 14px;
    }

    .key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      padding: 0 8px;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      font-family: monospace;
    }

    /* 无图片提示 - 黑色主题 */
    .no-image {
      color: rgba(255, 255, 255, 0.3);
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .no-image i {
      font-size: 48px;
      opacity: 0.2;
    }

    /* 滚动条样式 - 黑色主题 */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* 放大镜样式 */
    .magnifier {
      position: fixed;
      width: 200px;
      height: 200px;
      border: 3px solid #667eea;
      border-radius: 50%;
      pointer-events: none;
      display: none;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      z-index: 9998;
    }

    .magnifier.visible {
      display: block;
    }

    .magnifier-image {
      position: absolute;
      transform-origin: top left;
    }

    /* EXIF信息面板 */
    .exif-panel {
      position: fixed;
      right: -320px;
      top: 0;
      bottom: 0;
      width: 320px;
      background: rgba(20, 20, 20, 0.98);
      backdrop-filter: blur(20px);
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 100;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      padding: 20px;
    }

    .exif-panel.visible {
      right: 0;
    }

    .exif-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .exif-panel-header h3 {
      color: #e0e0e0;
      font-size: 16px;
      font-weight: 600;
    }

    .exif-close {
      background: none;
      border: none;
      color: #888;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .exif-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #e0e0e0;
    }

    .exif-section {
      margin-bottom: 20px;
    }

    .exif-section-title {
      color: #667eea;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }

    .exif-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .exif-item:last-child {
      border-bottom: none;
    }

    .exif-label {
      color: #888;
      font-size: 13px;
    }

    .exif-value {
      color: #e0e0e0;
      font-size: 13px;
      font-weight: 500;
      text-align: right;
    }

    .exif-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .exif-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .exif-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    /* 批量选择模式 */
    .batch-toggle {
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.04);
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .batch-toggle:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .batch-toggle.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .thumbnail-checkbox {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 18px;
      height: 18px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 3px;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }

    .thumbnail-checkbox.visible {
      display: flex;
    }

    .thumbnail-checkbox.checked {
      background: #667eea;
      border-color: #667eea;
    }

    .thumbnail-checkbox i {
      color: white;
      font-size: 12px;
    }

    /* 废片标记 - 评级栏背景变红 */
    .thumbnail-rating.rejected {
      background: rgba(224, 23, 23, 0.726) !important;
    }

    .thumbnail-rating.rejected .thumbnail-star {
      color: rgba(255, 255, 255, 0.5) !important;
    }

    .thumbnail-rating.rejected .thumbnail-star.active {
      color: white !important;
    }

    /* 删除按钮 */
    .delete-button {
      padding: 8px 16px;
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .delete-button:hover:not(.disabled) {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .delete-button.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* 删除确认对话框 */
    .delete-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      z-index: 9999;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .delete-modal.visible {
      display: flex;
    }

    .delete-modal-content {
      background: #1a1a1a;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .delete-modal-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .delete-modal-header i {
      font-size: 24px;
      color: #ef4444;
    }

    .delete-modal-header h3 {
      color: #e0e0e0;
      font-size: 18px;
      font-weight: 600;
    }

    .delete-modal-body {
      color: #888;
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    .delete-modal-body strong {
      color: #ef4444;
    }

    .delete-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }

    .delete-option {
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .delete-option:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .delete-option i {
      font-size: 18px;
      color: #ef4444;
    }

    .delete-option-text {
      color: #e0e0e0;
      font-size: 14px;
    }

    .delete-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .delete-modal-btn {
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-modal-btn.cancel {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #888;
    }

    .delete-modal-btn.cancel:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    /* 加载动画 */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .thumbnail-item {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .view-toggle-container {
      display: flex;
      gap: 4px;
      margin-right: 12px;
    }

    .view-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .view-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .view-btn.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .theme-selector {
      position: relative;
    }

    .theme-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.04);
      color: #666;
    }

    .theme-btn:hover {
      background: rgba(102, 126, 234, 0.15);
      color: #667eea;
    }

    .theme-dropdown {
      position: absolute;
      bottom: 100%;
      right: 0;
      margin-bottom: 8px;
      background: rgba(25, 25, 25, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 8px;
      min-width: 140px;
      display: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
    }

    .theme-dropdown.visible {
      display: block;
    }

    .theme-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      color: #aaa;
      font-size: 13px;
    }

    .theme-option:hover {
      background: rgba(255, 255, 255, 0.08);
      color: #e0e0e0;
    }

    .theme-option.active {
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
    }

    .theme-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }

    .file-tooltip {
      position: fixed;
      background: rgba(25, 25, 25, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      color: #e0e0e0;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 9999;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      max-width: 280px;
    }

    .file-tooltip.visible {
      opacity: 1;
    }

    .file-tooltip-row {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin-bottom: 6px;
    }

    .file-tooltip-row:last-child {
      margin-bottom: 0;
    }

    .file-tooltip-label {
      color: #888;
    }

    .file-tooltip-value {
      color: #e0e0e0;
      font-weight: 500;
    }

    .rating-stats {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 6px;
      font-size: 12px;
      color: #888;
    }

    .rating-stats-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .rating-stats-item i {
      font-size: 12px;
      color: #667eea;
    }

    .rating-stats-divider {
      width: 1px;
      height: 14px;
      background: rgba(255, 255, 255, 0.1);
    }

    .list-view .thumbnail-container {
      height: auto;
      max-height: 300px;
      padding: 8px 20px;
    }

    .list-view .thumbnail-wrapper {
      display: flex;
      flex-direction: column;
      white-space: normal;
    }

    .list-view .thumbnail-item {
      display: flex;
      flex-direction: row;
      align-items: center;
      width: 100%;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 8px;
    }

    .list-view .thumbnail-image-wrapper {
      width: 80px;
      height: 50px;
      flex-shrink: 0;
    }

    .list-view .thumbnail-rating {
      flex-direction: row;
      flex: 1;
      justify-content: flex-start;
      padding: 0 12px;
      background: transparent;
    }

    .list-view .thumbnail-format {
      margin-left: 4px;
    }

    .detail-view .thumbnail-container {
      height: auto;
      max-height: 400px;
    }

    .detail-view .thumbnail-item {
      width: 200px;
    }

    .detail-view .thumbnail-image-wrapper {
      width: 100%;
      height: 100px;
    }

    .detail-view .thumbnail-item::after {
      content: attr(data-filename);
      display: block;
      font-size: 10px;
      color: #888;
      text-align: center;
      padding: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    [data-theme="midnight"] body,
    [data-theme="midnight"] .container {
      background: #0a0a12;
    }

    [data-theme="midnight"] .title-bar,
    [data-theme="midnight"] .path-container,
    [data-theme="midnight"] .preview-container,
    [data-theme="midnight"] .thumbnail-container,
    [data-theme="midnight"] .toolbar {
      background: rgba(18, 18, 26, 0.98);
    }

    [data-theme="midnight"] .path-button,
    [data-theme="midnight"] .filter-btn.active,
    [data-theme="midnight"] .progress-bar {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    }

    [data-theme="ocean"] body,
    [data-theme="ocean"] .container {
      background: #0a1015;
    }

    [data-theme="ocean"] .title-bar,
    [data-theme="ocean"] .path-container,
    [data-theme="ocean"] .preview-container,
    [data-theme="ocean"] .thumbnail-container,
    [data-theme="ocean"] .toolbar {
      background: rgba(16, 24, 32, 0.98);
    }

    [data-theme="ocean"] .path-button,
    [data-theme="ocean"] .filter-btn.active,
    [data-theme="ocean"] .progress-bar {
      background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    }

    [data-theme="forest"] body,
    [data-theme="forest"] .container {
      background: #0a120d;
    }

    [data-theme="forest"] .title-bar,
    [data-theme="forest"] .path-container,
    [data-theme="forest"] .preview-container,
    [data-theme="forest"] .thumbnail-container,
    [data-theme="forest"] .toolbar {
      background: rgba(18, 26, 20, 0.98);
    }

    [data-theme="forest"] .path-button,
    [data-theme="forest"] .filter-btn.active,
    [data-theme="forest"] .progress-bar {
      background: linear-gradient(135deg, #22c55e 0%, #10b981 100%);
    }

    [data-theme="sunset"] body,
    [data-theme="sunset"] .container {
      background: #120a0a;
    }

    [data-theme="sunset"] .title-bar,
    [data-theme="sunset"] .path-container,
    [data-theme="sunset"] .preview-container,
    [data-theme="sunset"] .thumbnail-container,
    [data-theme="sunset"] .toolbar {
      background: rgba(26, 18, 18, 0.98);
    }

    [data-theme="sunset"] .path-button,
    [data-theme="sunset"] .filter-btn.active,
    [data-theme="sunset"] .header-progress-bar {
      background: linear-gradient(135deg, #f97316 0%, #ef4444 100%);
    }

    [data-theme="purple"] body,
    [data-theme="purple"] .container {
      background: #0f0a12;
    }

    [data-theme="purple"] .title-bar,
    [data-theme="purple"] .path-container,
    [data-theme="purple"] .preview-container,
    [data-theme="purple"] .thumbnail-container,
    [data-theme="purple"] .toolbar {
      background: rgba(22, 16, 26, 0.98);
    }

    [data-theme="purple"] .path-button,
    [data-theme="purple"] .filter-btn.active,
    [data-theme="purple"] .header-progress-bar {
      background: linear-gradient(135deg, #a855f7 0%, #d946ef 100%);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 标题栏 -->
    <div class="title-bar">
      <div class="window-title">
        <i class="ri-image-line"></i>
        QuickPick - 图片查看管理器
      </div>
      <div class="title-bar-center">
        <div class="title-bar-stats" id="titleBarStats">
          <span class="title-bar-stats-item clickable" id="statsJpgOnly" title="仅JPG格式"><i class="ri-image-line"></i><span>0</span></span>
          <span class="title-bar-stats-divider"></span>
          <span class="title-bar-stats-item clickable" id="statsRawOnly" title="仅RAW格式"><i class="ri-file-unknow-line"></i><span>0</span></span>
          <span class="title-bar-stats-divider"></span>
          <span class="title-bar-stats-item clickable" id="statsBoth" title="双格式(JPG+RAW)"><i class="ri-file-copy-line"></i><span>0</span></span>
          <span class="title-bar-stats-divider"></span>
          <span class="title-bar-stats-item clickable active" id="statsTotal" title="总计"><i class="ri-gallery-line"></i><span>0</span></span>
        </div>
        <button class="title-bar-help" id="helpButton" title="快捷键帮助"><i class="ri-keyboard-line"></i></button>
      </div>
      <div class="window-controls">
        <button class="control-button minimize"><i class="ri-subtract-line"></i></button>
        <button class="control-button maximize"><i class="ri-checkbox-blank-line"></i></button>
        <button class="control-button close"><i class="ri-close-line"></i></button>
      </div>
    </div>
    <!-- 非阻塞进度条 -->
    <div class="header-progress" id="headerProgress">
      <div class="header-progress-bar" id="headerProgressBar"></div>
      <div class="header-progress-text" id="headerProgressText"></div>
    </div>
    <!-- 顶部路径管理模块 -->
    <div class="path-container">
      <div class="path-item">
        <span class="path-label"><i class="ri-image-2-line"></i>JPG路径</span>
        <input type="text" class="path-input" id="jpgPath" placeholder="请输入JPG文件路径">
        <button class="path-button" id="jpgBrowse"><i class="ri-folder-open-line"></i>浏览</button>
      </div>
      <div class="path-item">
        <span class="path-label"><i class="ri-camera-line"></i>RAW路径</span>
        <input type="text" class="path-input" id="rawPath" placeholder="请输入RAW文件路径">
        <button class="path-button" id="rawBrowse"><i class="ri-folder-open-line"></i>浏览</button>
      </div>
      <button class="path-button" id="loadButton" style="white-space: nowrap;"><i class="ri-refresh-line"></i>加载图片</button>
    </div>

    <!-- 中间预览区域 -->
    <div class="preview-container">
      <div class="preview-wrapper" id="previewWrapper">
        <div class="no-image" id="noImage">
          <i class="ri-image-add-line"></i>
          <span></span>
        </div>
      </div>
      <div class="rating-container" id="ratingContainer">
        <div class="batch-info-inline" id="batchInfoInline" style="display: none;">
          <span>已选择 <strong id="batchCountInline">0</strong> 张</span>
          <button class="batch-cancel-inline" id="batchCancelInline" title="取消选择"><i class="ri-close-line"></i></button>
        </div>
        <div class="rating-stars">
          <span class="star" data-rating="1"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="2"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="3"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="4"><i class="ri-star-fill"></i></span>
          <span class="star" data-rating="5"><i class="ri-star-fill"></i></span>
        </div>
      </div>
    </div>

    <!-- 底部缩略图区域 -->
    <div class="thumbnail-resize-handle" id="thumbnailResizeHandle"></div>
    <div class="thumbnail-container" id="thumbnailContainer">
      <div class="thumbnail-wrapper" id="thumbnailWrapper">
      </div>
    </div>

    <!-- 操作栏 -->
    <div class="toolbar">
      <div class="filter-container">
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all" title="全部">
            <i class="ri-apps-line"></i>
          </button>
          <button class="filter-btn" data-filter="any" title="有星">
            <i class="ri-star-fill"></i>
          </button>
          <button class="filter-btn" data-filter="none" title="无星">
            <i class="ri-star-line"></i>
          </button>
          <button class="filter-btn" data-filter="equal" title="等于">
            <i class="ri-equal-line"></i>
          </button>
          <button class="filter-btn" data-filter="greater" title="大于等于">
            <i class="ri-arrow-up-circle-line"></i>
          </button>
          <button class="filter-btn" data-filter="less" title="小于等于">
            <i class="ri-arrow-down-circle-line"></i>
          </button>
        </div>
        <div class="filter-stars" id="filterStars">
          <span class="filter-star" data-rating="1"><i class="ri-star-fill"></i><span class="filter-star-count" id="filterStar1">0</span></span>
          <span class="filter-star" data-rating="2"><i class="ri-star-fill"></i><span class="filter-star-count" id="filterStar2">0</span></span>
          <span class="filter-star" data-rating="3"><i class="ri-star-fill"></i><span class="filter-star-count" id="filterStar3">0</span></span>
          <span class="filter-star" data-rating="4"><i class="ri-star-fill"></i><span class="filter-star-count" id="filterStar4">0</span></span>
          <span class="filter-star" data-rating="5"><i class="ri-star-fill"></i><span class="filter-star-count" id="filterStar5">0</span></span>
        </div>
        <span class="filter-status" id="filterStatus">未筛选</span>
      </div>
      <div class="view-toggle-container">
        <button class="view-btn active" data-view="grid" title="网格视图">
          <i class="ri-grid-line"></i>
        </button>
        <button class="view-btn" data-view="detail" title="详情视图">
          <i class="ri-gallery-line"></i>
        </button>
      </div>
      <!-- <div class="theme-selector">
        <button class="theme-btn" id="themeBtn" title="主题选择">
          <i class="ri-palette-line"></i>
        </button>
        <div class="theme-dropdown" id="themeDropdown">
          <div class="theme-option active" data-theme="default">
            <div class="theme-color" style="background: linear-gradient(135deg, #667eea, #764ba2);"></div>
            <span>默认紫</span>
          </div>
          <div class="theme-option" data-theme="midnight">
            <div class="theme-color" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);"></div>
            <span>午夜蓝</span>
          </div>
          <div class="theme-option" data-theme="ocean">
            <div class="theme-color" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4);"></div>
            <span>海洋青</span>
          </div>
          <div class="theme-option" data-theme="forest">
            <div class="theme-color" style="background: linear-gradient(135deg, #22c55e, #10b981);"></div>
            <span>森林绿</span>
          </div>
          <div class="theme-option" data-theme="sunset">
            <div class="theme-color" style="background: linear-gradient(135deg, #f97316, #ef4444);"></div>
            <span>日落橙</span>
          </div>
          <div class="theme-option" data-theme="purple">
            <div class="theme-color" style="background: linear-gradient(135deg, #a855f7, #d946ef);"></div>
            <span>魅惑紫</span>
          </div>
        </div>
      </div> -->
      <button class="batch-toggle" id="batchToggle" title="批量选择">
        <i class="ri-checkbox-multiple-line"></i>
      </button>
      <button class="exif-toggle" id="exifToggle" title="EXIF信息">
        <i class="ri-file-info-line"></i>
      </button>
      <button class="magnifier-toggle" id="magnifierToggle" title="放大镜 (默认关闭)">
        <i class="ri-search-eye-line"></i>
      </button>
      <button class="export-button" id="exportButton"><i class="ri-download-2-line"></i>导出文件</button>
      <button class="delete-button disabled" id="deleteButton" disabled><i class="ri-delete-bin-line"></i>删除废片</button>
    </div>

    <!-- 删除确认对话框 -->
    <div class="delete-modal" id="deleteModal">
      <div class="delete-modal-content">
        <div class="delete-modal-header">
          <i class="ri-error-warning-line"></i>
          <h3>确认删除</h3>
        </div>
        <div class="delete-modal-body">
          您已标记 <strong id="rejectedCount">0</strong> 张废片，请选择删除方式：
        </div>
        <div class="delete-options">
          <div class="delete-option" id="deleteBoth">
            <i class="ri-file-copy-line"></i>
            <span class="delete-option-text">删除 JPG 和 RAW 文件</span>
          </div>
          <div class="delete-option" id="deleteJpg">
            <i class="ri-image-line"></i>
            <span class="delete-option-text">仅删除 JPG 文件</span>
          </div>
          <div class="delete-option" id="deleteRaw">
            <i class="ri-file-unknow-line"></i>
            <span class="delete-option-text">仅删除 RAW 文件</span>
          </div>
        </div>
        <div class="delete-modal-footer">
          <button class="delete-modal-btn cancel" id="deleteCancel">取消</button>
        </div>
      </div>
    </div>

    <!-- EXIF信息面板 -->
    <div class="exif-panel" id="exifPanel">
      <div class="exif-panel-header">
        <h3>EXIF 信息</h3>
        <button class="exif-close" id="exifClose"><i class="ri-close-line"></i></button>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">相机信息</div>
        <div class="exif-item">
          <span class="exif-label">相机型号</span>
          <span class="exif-value" id="exifCamera">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">镜头型号</span>
          <span class="exif-value" id="exifLens">-</span>
        </div>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">拍摄参数</div>
        <div class="exif-item">
          <span class="exif-label">光圈</span>
          <span class="exif-value" id="exifAperture">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">快门速度</span>
          <span class="exif-value" id="exifShutter">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">ISO</span>
          <span class="exif-value" id="exifISO">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">焦距</span>
          <span class="exif-value" id="exifFocalLength">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">曝光补偿</span>
          <span class="exif-value" id="exifExposureBias">-</span>
        </div>
      </div>
      <div class="exif-section">
        <div class="exif-section-title">图片信息</div>
        <div class="exif-item">
          <span class="exif-label">分辨率</span>
          <span class="exif-value" id="exifResolution">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">拍摄时间</span>
          <span class="exif-value" id="exifDateTime">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">文件大小</span>
          <span class="exif-value" id="exifFileSize">-</span>
        </div>
        <div class="exif-item">
          <span class="exif-label">文件名</span>
          <span class="exif-value" id="exifFileName">-</span>
        </div>
      </div>
    </div>

    <!-- 文件信息悬浮提示 -->
    <div class="file-tooltip" id="fileTooltip">
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">文件名</span>
        <span class="file-tooltip-value" id="tooltipFileName">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">文件大小</span>
        <span class="file-tooltip-value" id="tooltipFileSize">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">分辨率</span>
        <span class="file-tooltip-value" id="tooltipResolution">-</span>
      </div>
      <div class="file-tooltip-row">
        <span class="file-tooltip-label">评级</span>
        <span class="file-tooltip-value" id="tooltipRating">-</span>
      </div>
    </div>

    <!-- 快捷键帮助弹窗 -->
    <div class="help-modal" id="helpModal">
      <div class="help-modal-content">
        <div class="help-modal-header">
          <h3>键盘快捷键</h3>
          <button class="help-close" id="helpClose"><i class="ri-close-line"></i></button>
        </div>
        <div class="help-modal-body">
          <div class="help-section">
            <h4>导航</h4>
            <div class="help-item"><span class="key">←</span><span class="key">→</span> 切换图片</div>
            <div class="help-item"><span class="key">Home</span> 第一张图片</div>
            <div class="help-item"><span class="key">End</span> 最后一张图片</div>
          </div>
          <div class="help-section">
            <h4>评级</h4>
            <div class="help-item"><span class="key">1-5</span> 设置1-5星</div>
            <div class="help-item"><span class="key">0</span> 取消评级</div>
            <div class="help-item"><span class="key">Space</span> 切换标记</div>
            <div class="help-item"><span class="key">Delete</span> 标记/取消废片</div>
          </div>
          <div class="help-section">
            <h4>缩放</h4>
            <div class="help-item"><span class="key">+</span> 放大</div>
            <div class="help-item"><span class="key">-</span> 缩小</div>
            <div class="help-item"><span class="key">Esc</span> 重置缩放/退出批量模式</div>
          </div>
          <div class="help-section">
            <h4>批量操作</h4>
            <div class="help-item"><span class="key">B</span> 进入/退出批量模式</div>
            <div class="help-item"><span class="key">Ctrl+A</span> 全选缩略图</div>
            <div class="help-item"><span class="key">Shift+点击</span> 范围多选</div>
            <div class="help-item"><span class="key">1-5</span> 批量设置星级</div>
            <div class="help-item"><span class="key">Delete</span> 批量标记废片</div>
          </div>
          <div class="help-section">
            <h4>其他</h4>
            <div class="help-item"><span class="key">F</span> 全屏模式</div>
            <div class="help-item"><span class="key">M</span> 开启/关闭放大镜</div>
            <div class="help-item"><span class="key">右键</span> 关闭放大镜</div>
            <div class="help-item"><span class="key">Ctrl+E</span> 导出文件</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 放大镜 -->
    <div class="magnifier" id="magnifier">
      <img class="magnifier-image" id="magnifierImage" alt="">
    </div>
  </div>

  <script>
    let jpgPath = '';
    let rawPath = '';
    let imageGroups = [];
    let filteredGroups = [];
    let currentIndex = 0;
    let ratingsData = {};
    let filterCondition = 'all';
    let filterRating = 0;
    let formatFilter = 'all';
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let mouseOffsetX = 0;
    let mouseOffsetY = 0;
    let currentScale = 1;
    let offsetX = 0;
    let offsetY = 0;

    function joinPath(...parts) {
      return parts.join('/').replace(/\/+/g, '/');
    }

    const RAW_EXTENSIONS = ['.cr2', '.cr3', '.arw', '.nef', '.dng', '.raw'];

    function isRawFile(path) {
      const ext = path.toLowerCase();
      return RAW_EXTENSIONS.some(e => ext.endsWith(e));
    }

    let currentLoadingId = 0;

    const MAX_IMAGE_CACHE = 100;
    const MAX_THUMBNAIL_CACHE = 200;



    class LRUCache {
      constructor(maxSize) {
        this.maxSize = maxSize;
        this.cache = new Map();
        this.order = [];
      }
      
      get(key) {
        if (this.cache.has(key)) {
          this.updateOrder(key);
          return this.cache.get(key);
        }
        return null;
      }
      
      set(key, value) {
        if (this.cache.has(key)) {
          this.updateOrder(key);
        } else {
          this.order.push(key);
        }
        this.cache.set(key, value);
        this.evict();
      }
      
      updateOrder(key) {
        const index = this.order.indexOf(key);
        if (index !== -1) {
          this.order.splice(index, 1);
          this.order.push(key);
        }
      }
      
      evict() {
        while (this.cache.size > this.maxSize && this.order.length > 0) {
          const oldestKey = this.order.shift();
          this.cache.delete(oldestKey);
        }
      }
      
      clear() {
        this.cache.clear();
        this.order = [];
      }
      
      get size() {
        return this.cache.size;
      }
    }
    
    const previewCache = new LRUCache(MAX_IMAGE_CACHE);
    const thumbnailLRUCache = new LRUCache(MAX_THUMBNAIL_CACHE);

    let currentView = 'grid';
    let currentTheme = 'default';
    let tooltipTimeout = null;
    let cachedWrapperRect = null;
    let cachedImgRect = null;
    let rafId = null;
    let lazyImageObserver = null;
    let fileMetadataCache = new Map();

    document.addEventListener('DOMContentLoaded', () => {
      initEventListeners();
      loadRatingsData();
      initMagnifier();
      initExifPanel();
      initBatchMode();
      initThumbnailResize();
      initViewToggle();
      initThemeSelector();
      initFileTooltip();
      initLazyImageObserver();
    });

    // 初始化事件监听器
    function initEventListeners() {
      // 恢复文本选择功能
      document.body.style.userSelect = 'auto';
      document.body.style.webkitUserSelect = 'auto';
      document.body.style.msUserSelect = 'auto';
      
      // 窗口控制按钮
      document.querySelector('.control-button.minimize').addEventListener('click', () => {
        window.electronAPI.window.minimize();
      });
      
      document.querySelector('.control-button.maximize').addEventListener('click', () => {
        window.electronAPI.window.maximize();
      });
      
      document.querySelector('.control-button.close').addEventListener('click', () => {
        window.electronAPI.window.close();
      });
      
      // 路径管理
      document.getElementById('jpgBrowse').addEventListener('click', () => browseDirectory('jpg'));
      document.getElementById('rawBrowse').addEventListener('click', () => browseDirectory('raw'));
      document.getElementById('loadButton').addEventListener('click', loadImages);
      document.getElementById('jpgPath').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadImages();
      });
      document.getElementById('rawPath').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') loadImages();
      });

      // 格式筛选（标题栏统计点击）
      document.getElementById('statsJpgOnly').addEventListener('click', () => setFormatFilter('jpg'));
      document.getElementById('statsRawOnly').addEventListener('click', () => setFormatFilter('raw'));
      document.getElementById('statsBoth').addEventListener('click', () => setFormatFilter('both'));
      document.getElementById('statsTotal').addEventListener('click', () => setFormatFilter('all'));

      // 星级评级
      document.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          setRating(rating);
        });
        
        // hover效果 - 选高星级，低星级都亮
        star.addEventListener('mouseenter', () => {
          const rating = parseInt(star.dataset.rating);
          document.querySelectorAll('.star').forEach(s => {
            const sRating = parseInt(s.dataset.rating);
            if (sRating <= rating) {
              s.classList.add('hover-active');
            } else {
              s.classList.remove('hover-active');
            }
          });
        });
        
        star.addEventListener('mouseleave', () => {
          document.querySelectorAll('.star').forEach(s => {
            s.classList.remove('hover-active');
          });
        });
      });

      // 筛选
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const filter = btn.dataset.filter;
          setFilterCondition(filter);
        });
      });
      document.querySelectorAll('.filter-star').forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          setFilterRating(rating);
        });
        
        // hover效果 - 选高星级，低星级都亮
        star.addEventListener('mouseenter', () => {
          const rating = parseInt(star.dataset.rating);
          document.querySelectorAll('.filter-star').forEach(s => {
            const sRating = parseInt(s.dataset.rating);
            if (sRating <= rating) {
              s.classList.add('hover-active');
            } else {
              s.classList.remove('hover-active');
            }
          });
        });
        
        star.addEventListener('mouseleave', () => {
          document.querySelectorAll('.filter-star').forEach(s => {
            s.classList.remove('hover-active');
          });
        });
      });

      // 导出
      document.getElementById('exportButton').addEventListener('click', exportFiles);

      // 删除废片
      document.getElementById('deleteButton').addEventListener('click', showDeleteModal);
      document.getElementById('deleteCancel').addEventListener('click', hideDeleteModal);
      document.getElementById('deleteModal').addEventListener('click', (e) => {
        if (e.target.id === 'deleteModal') {
          hideDeleteModal();
        }
      });
      document.getElementById('deleteBoth').addEventListener('click', () => deleteRejectedFiles('both'));
      document.getElementById('deleteJpg').addEventListener('click', () => deleteRejectedFiles('jpg'));
      document.getElementById('deleteRaw').addEventListener('click', () => deleteRejectedFiles('raw'));

      // 快捷键帮助
      document.getElementById('helpButton').addEventListener('click', () => {
        document.getElementById('helpModal').classList.add('visible');
      });

      document.getElementById('helpClose').addEventListener('click', () => {
        document.getElementById('helpModal').classList.remove('visible');
      });

      document.getElementById('helpModal').addEventListener('click', (e) => {
        if (e.target.id === 'helpModal') {
          document.getElementById('helpModal').classList.remove('visible');
        }
      });

      // 键盘快捷键
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT') return;
        
        if (e.ctrlKey || e.metaKey) {
          switch (e.key.toLowerCase()) {
            case 'e':
              e.preventDefault();
              exportFiles();
              break;
            case 'a':
              e.preventDefault();
              selectAllThumbnails();
              break;
          }
          return;
        }
        
        switch (e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            if (!e.repeat) {
              navigateImage(-1);
            }
            break;
          case 'ArrowRight':
            e.preventDefault();
            if (!e.repeat) {
              navigateImage(1);
            }
            break;
          case '1':
          case '2':
          case '3':
          case '4':
          case '5':
            e.preventDefault();
            if (batchMode && selectedThumbnails.size > 0) {
              batchSetRating(parseInt(e.key));
            } else {
              setRating(parseInt(e.key));
            }
            break;
          case '0':
            e.preventDefault();
            if (batchMode && selectedThumbnails.size > 0) {
              batchSetRating(0);
            } else {
              setRating(0);
            }
            break;
          case '+':
          case '=':
            e.preventDefault();
            scaleImage(1.2);
            break;
          case '-':
            e.preventDefault();
            scaleImage(0.8);
            break;
          case 'b':
            e.preventDefault();
            toggleBatchMode();
            break;
          case 'f':
            e.preventDefault();
            toggleFullscreen();
            break;
          case 'm':
            e.preventDefault();
            toggleMagnifier(!magnifierEnabled);
            break;
          case 'Delete':
          case 'Backspace':
            e.preventDefault();
            if (batchMode && selectedThumbnails.size > 0) {
              batchToggleRejected();
            } else {
              toggleRejected();
            }
            break;
          case ' ':
            e.preventDefault();
            toggleMark();
            break;
          case 'Home':
            e.preventDefault();
            showImage(0);
            break;
          case 'End':
            e.preventDefault();
            showImage(filteredGroups.length - 1);
            break;
          case 'Escape':
            e.preventDefault();
            if (magnifierEnabled) {
              toggleMagnifier(false);
            } else if (batchMode) {
              toggleBatchMode();
            } else {
              resetZoom();
            }
            break;
        }
      });

      // 鼠标滚轮缩放
      document.getElementById('previewWrapper').addEventListener('wheel', (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 0.9 : 1.1;
        scaleImage(delta, e.clientX, e.clientY);
      });

      // 拖拽移动 - 使用左键拖拽，同时禁用文本选择
      const previewWrapper = document.getElementById('previewWrapper');
      
      // 监听鼠标按下事件，响应左键
      previewWrapper.addEventListener('mousedown', (e) => {
        // 检查是否是左键
        if (e.button === 0 && e.target.classList.contains('preview-image')) {
          // 禁用文本选择
          e.preventDefault();
          startDrag(e);
        }
      });
      
      // 监听鼠标移动事件
      document.addEventListener('mousemove', (e) => {
        // 如果正在拖拽，禁用文本选择
        if (isDragging) {
          e.preventDefault();
        }
        drag(e);
      });
      
      // 监听鼠标释放事件
      document.addEventListener('mouseup', (e) => {
        // 检查是否是左键
        if (e.button === 0) {
          endDrag();
        }
      });
      
      // 添加鼠标移出窗口时的处理，确保拖拽状态能够正确结束
      document.addEventListener('mouseleave', endDrag);
      previewWrapper.addEventListener('mouseleave', endDrag);
      
      const thumbnailContainer = document.getElementById('thumbnailContainer');
      
      thumbnailContainer.addEventListener('wheel', (e) => {
        if (e.deltaY !== 0) {
          e.preventDefault();
          thumbnailContainer.scrollLeft += e.deltaY;
        }
      }, { passive: false });
      
      // 批量模式下双击预览图选中/取消选中
      previewWrapper.addEventListener('dblclick', (e) => {
        if (!batchMode) return;
        const img = e.target.closest('.preview-image');
        if (img) {
          toggleThumbnailSelection(currentIndex, e.shiftKey);
        }
      });
    }

    // 浏览目录
    async function browseDirectory(type) {
      try {
        const path = await window.electronAPI.openDirectoryDialog({});
        if (path) {
          document.getElementById(`${type}Path`).value = path;
          // 自动加载图片
          loadImages();
        }
      } catch (error) {
        console.error('浏览目录失败:', error);
      }
    }

    // 加载图片
    async function loadImages() {
      try {
        // 获取路径
        const jpgInput = document.getElementById('jpgPath').value;
        const rawInput = document.getElementById('rawPath').value;

        // 验证路径
        if (jpgInput) {
          const jpgExists = await window.electronAPI.fs.existsSync(jpgInput);
          if (!jpgExists) {
            showMessage('错误', 'JPG路径不存在', 'error');
            return;
          }
          jpgPath = jpgInput;
        }

        if (rawInput) {
          const rawExists = await window.electronAPI.fs.existsSync(rawInput);
          if (!rawExists) {
            showMessage('错误', 'RAW路径不存在', 'error');
            return;
          }
          rawPath = rawInput;
        }

        // 显示进度条
        showProgress('加载图片...');

        // 扫描文件
        await scanFiles();
      } catch (error) {
        console.error('加载图片失败:', error);
        hideProgress();
        showMessage('错误', '操作失败', 'error');
      }
    }

    // 扫描文件
    async function scanFiles() {
      try {
        const jpgFiles = [];
        const rawFiles = [];

        // 更新进度
        updateProgress(0, 4, '扫描JPG文件...');

        // 扫描JPG文件
        if (jpgPath) {
          const files = await window.electronAPI.fs.readdir(jpgPath);
          jpgFiles.push(...files.filter(file => {
            const ext = file.toLowerCase();
            return ext.endsWith('.jpg') || ext.endsWith('.jpeg');
          }).map(file => ({ path: joinPath(jpgPath, file), name: file, type: 'jpg' })));
        }

        updateProgress(1, 4, '扫描RAW文件...');

        // 扫描RAW文件
        if (rawPath) {
          const files = await window.electronAPI.fs.readdir(rawPath);
          rawFiles.push(...files.filter(file => {
            return isRawFile(file);
          }).map(file => ({ path: joinPath(rawPath, file), name: file, type: 'raw' })));
        }

        updateProgress(2, 4, '生成图片组...');

        // 生成图片组
        generateImageGroups(jpgFiles, rawFiles);

        updateProgress(3, 4, '加载评级数据...');

        // 加载星级数据
        await loadRatingsData();

        // 应用筛选
        applyFilter();

        // 显示第一张图片
        if (filteredGroups.length > 0) {
          showImage(0);
        } else {
          showNoImage();
        }

        // 隐藏进度条
        hideProgress();
      } catch (error) {
        console.error('扫描文件失败:', error);
        hideProgress();
        showMessage('错误', '扫描文件失败', 'error');
      }
    }

    // 生成图片组
    function generateImageGroups(jpgFiles, rawFiles) {
      const groups = {};

      // 添加JPG文件
      jpgFiles.forEach(file => {
        const prefix = getFilePrefix(file.name);
        if (!groups[prefix]) {
          groups[prefix] = { jpg: null, raw: null };
        }
        groups[prefix].jpg = file;
      });

      // 添加RAW文件
      rawFiles.forEach(file => {
        const prefix = getFilePrefix(file.name);
        if (!groups[prefix]) {
          groups[prefix] = { jpg: null, raw: null };
        }
        groups[prefix].raw = file;
      });

      // 转换为数组并排序
      imageGroups = Object.values(groups).filter(group => group.jpg || group.raw);
      imageGroups.sort((a, b) => {
        const nameA = (a.jpg || a.raw).name;
        const nameB = (b.jpg || b.raw).name;
        return nameA.localeCompare(nameB);
      });
    }

    // 获取文件前缀
    function getFilePrefix(filename) {
      return filename.replace(/\.[^/.]+$/, '');
    }

    // 应用筛选
    function applyFilter() {
      filteredGroups = imageGroups.filter(group => {
        // 格式筛选
        if (formatFilter === 'jpg' && (group.raw || !group.jpg)) {
          return false;
        }
        if (formatFilter === 'raw' && (group.jpg || !group.raw)) {
          return false;
        }
        if (formatFilter === 'both' && (!group.jpg || !group.raw)) {
          return false;
        }

        // 星级筛选
        const file = group.jpg || group.raw;
        const fileName = file.name;
        const rating = ratingsData[fileName]?.rating || 0;

        switch (filterCondition) {
          case 'all':
            return true;
          case 'equal':
            return rating === filterRating;
          case 'greater':
            return rating >= filterRating;
          case 'less':
            return rating <= filterRating;
          case 'none':
            return rating === 0;
          case 'any':
            return rating > 0;
          default:
            return true;
        }
      });

      updateThumbnails(filteredGroups);
      updateFilterStatus();
      updateRatingStats();

      if (filteredGroups.length > 0) {
        showImage(0);
      } else {
        showNoImage();
      }
    }

    function updateThumbnails(groups) {
      const wrapper = document.getElementById('thumbnailWrapper');
      wrapper.innerHTML = '';

      const fragment = document.createDocumentFragment();

      groups.forEach((group, index) => {
        const thumbnailFile = group.jpg || group.raw;
        if (!thumbnailFile) return;

        const fileName = thumbnailFile.name;
        const rating = ratingsData[fileName]?.rating || 0;
        
        let ratingStars = '';
        for (let i = 1; i <= 5; i++) {
          const isActive = i <= rating ? 'active' : '';
          ratingStars += `<span class="thumbnail-star ${isActive}" data-rating="${i}" data-index="${index}"><i class="ri-star-fill"></i></span>`;
        }

        const thumbnailItem = document.createElement('div');
        thumbnailItem.className = 'thumbnail-item';
        thumbnailItem.dataset.index = index;
        thumbnailItem.dataset.filename = fileName;

        let formatLabels = '';
        if (group.jpg && group.raw) {
          formatLabels = `
            <div class="thumbnail-rating-formats">
              <span class="thumbnail-format jpg">J</span>
              <span class="thumbnail-format raw">R</span>
            </div>
          `;
        } else {
          formatLabels = `
            <span class="thumbnail-format ${thumbnailFile.type}">${thumbnailFile.type.toUpperCase().charAt(0)}</span>
          `;
        }

        thumbnailItem.innerHTML = `
          <div class="thumbnail-checkbox" data-index="${index}">
            <i class="ri-check-line"></i>
          </div>
          <div class="thumbnail-image-wrapper">
            <img class="thumbnail-image lazy" data-src="${thumbnailFile.path}" alt="${thumbnailFile.name}" loading="lazy">
            <div class="thumbnail-overlay"></div>
          </div>
          <div class="thumbnail-rating ${rejectedImages.has(fileName) ? 'rejected' : ''}">${formatLabels}${ratingStars}</div>
        `;

        thumbnailItem.addEventListener('click', handleThumbnailClick);
        thumbnailItem.addEventListener('contextmenu', handleThumbnailRightClick);

        // 缩略图星级hover效果
        const thumbnailStars = thumbnailItem.querySelectorAll('.thumbnail-star');
        thumbnailStars.forEach(star => {
          star.addEventListener('mouseenter', (e) => {
            e.stopPropagation();
            const rating = parseInt(star.dataset.rating);
            thumbnailStars.forEach(s => {
              const sRating = parseInt(s.dataset.rating);
              if (sRating <= rating) {
                s.classList.add('hover-active');
              } else {
                s.classList.remove('hover-active');
              }
            });
          });
          
          star.addEventListener('mouseleave', (e) => {
            e.stopPropagation();
            thumbnailStars.forEach(s => {
              s.classList.remove('hover-active');
            });
          });
        });

        const checkbox = thumbnailItem.querySelector('.thumbnail-checkbox');
        checkbox.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleThumbnailSelection(index, e.shiftKey);
        });

        const img = thumbnailItem.querySelector('.thumbnail-image.lazy');
        if (lazyImageObserver) {
          lazyImageObserver.observe(img);
        } else {
          loadThumbnailImage(img);
        }

        fragment.appendChild(thumbnailItem);
      });

      wrapper.appendChild(fragment);
      updateThumbnailCheckboxes();
      updateThumbnailSelection(currentIndex);
      setupLazyLoading();
    }

    function handleThumbnailScroll(groups) {
    }

    function handleThumbnailClick(e) {
      const thumbnailItem = e.currentTarget;
      const index = parseInt(thumbnailItem.dataset.index);
      
      if (e.target.closest('.thumbnail-star')) {
        const star = e.target.closest('.thumbnail-star');
        const starRating = parseInt(star.dataset.rating);
        setThumbnailRating(index, starRating);
      } else if (batchMode) {
        showImage(index);
        toggleThumbnailSelection(index, e.shiftKey);
      } else {
        showImage(index);
      }
    }

    function handleThumbnailRightClick(e) {
      e.preventDefault();
      
      if (!batchMode) return;
      
      const thumbnailItem = e.currentTarget;
      const index = parseInt(thumbnailItem.dataset.index);
      
      toggleThumbnailSelection(index, e.shiftKey);
    }

    function initLazyImageObserver() {
      if ('IntersectionObserver' in window) {
        lazyImageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              loadThumbnailImage(img);
              observer.unobserve(img);
            }
          });
        }, {
          rootMargin: '100px',
          threshold: 0.01
        });
      }
    }

    function setupLazyLoading() {
      const lazyImages = document.querySelectorAll('.thumbnail-image.lazy');
      
      if (lazyImageObserver) {
        lazyImages.forEach(img => {
          lazyImageObserver.observe(img);
        });
      } else {
        lazyImages.forEach(img => {
          loadThumbnailImage(img);
        });
      }
    }
    
    async function loadThumbnailImage(img) {
      const filePath = img.dataset.src;
      if (!filePath) return;
      
      const cachedThumbnail = thumbnailLRUCache.get(filePath);
      if (cachedThumbnail) {
        img.src = cachedThumbnail;
        img.classList.remove('lazy');
        return;
      }

      if (isRawFile(filePath)) {
        try {
          const result = await window.electronAPI.image.getThumbnail(filePath, 240);
          if (result.data) {
            const dataUrl = `data:image/jpeg;base64,${result.data}`;
            thumbnailLRUCache.set(filePath, dataUrl);
            img.src = dataUrl;
            img.classList.remove('lazy');
            return;
          }
        } catch (e) {
          console.error('加载RAW缩略图失败:', e);
        }
      }
      
      img.src = filePath;
      img.classList.remove('lazy');
      thumbnailLRUCache.set(filePath, filePath);
    }

    async function setThumbnailRating(index, rating) {
      const group = filteredGroups[index];
      if (!group) return;

      if (group.jpg) {
        updateRating(group.jpg.path, rating);
        window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[group.jpg.name].rating);
      }
      if (group.raw) {
        updateRating(group.raw.path, rating);
        window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[group.raw.name].rating);
      }

      const actualRating = ratingsData[group.jpg?.name || group.raw?.name]?.rating || 0;

      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (thumbnailItem) {
        const stars = thumbnailItem.querySelectorAll('.thumbnail-star');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating);
          star.classList.toggle('active', starRating <= actualRating);
        });
      }
      
      if (currentIndex === index) {
        updateRatingDisplay(group.jpg?.path || group.raw?.path);
      }
    }

    function showImage(index) {
      if (index < 0 || index >= filteredGroups.length) return;

      currentIndex = index;
      const group = filteredGroups[index];

      const displayFile = group.jpg || group.raw;
      if (!displayFile) return;

      const previewWrapper = document.getElementById('previewWrapper');
      previewWrapper.innerHTML = '';

      const loadingId = ++currentLoadingId;

      const showProgressiveImage = async () => {
        const isRaw = isRawFile(displayFile.path);

        let lowQualitySrc = null;
        let highQualitySrc = null;
        
        const img = document.createElement('img');
        img.className = 'preview-image';
        img.alt = displayFile.name;
        
        const cachedPreview = previewCache.get(displayFile.path);
        if (cachedPreview) {
          highQualitySrc = cachedPreview;
        } else {
          if (isRaw) {
            try {
              const previewResult = await window.electronAPI.image.getPreview(displayFile.path);
              if (previewResult.data && loadingId === currentLoadingId) {
                lowQualitySrc = `data:image/jpeg;base64,${previewResult.data}`;
              }
            } catch (e) {
              console.error('获取RAW预览失败:', e);
            }
          }
          
          highQualitySrc = displayFile.path;
        }
        
        if (loadingId !== currentLoadingId) return;
        
        if (lowQualitySrc) {
          img.src = lowQualitySrc;
          img.style.filter = 'blur(2px)';
          img.style.transition = 'filter 0.3s ease';
          previewWrapper.appendChild(img);
          
          currentScale = 1;
          offsetX = 0;
          offsetY = 0;
          updateImageTransform(img);
          
          const highQualityImg = new Image();
          highQualityImg.onload = () => {
            if (loadingId !== currentLoadingId) return;
            img.src = highQualitySrc;
            img.style.filter = 'none';
            previewCache.set(displayFile.path, highQualitySrc);
          };
          highQualityImg.src = highQualitySrc;
        } else {
          img.src = highQualitySrc || displayFile.path;
          previewWrapper.appendChild(img);
          
          currentScale = 1;
          offsetX = 0;
          offsetY = 0;
          updateImageTransform(img);
          
          if (!cachedPreview) {
            previewCache.set(displayFile.path, displayFile.path);
          }
        }
        
        updateRatingDisplay(displayFile.path);
        
        if (exifPanelVisible) {
          updateExifDisplay();
        }
        
        updateThumbnailSelection(index);
      };
      
      showProgressiveImage();
    }

    // 显示无图片提示
    function showNoImage() {
      const previewWrapper = document.getElementById('previewWrapper');
      previewWrapper.innerHTML = '<div class="no-image">无图片可显示</div>';
      updateRatingDisplay(null);
    }

    // 更新图片变换
    function updateImageTransform(img) {
      if (!img) return;
      img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${currentScale})`;
    }

    // 计算并约束图片位置
    function constrainImagePosition() {
      const img = document.querySelector('.preview-image');
      if (!img) return;

      const wrapper = document.getElementById('previewWrapper');
      const wrapperRect = wrapper.getBoundingClientRect();
      
      const imgWidth = img.naturalWidth * currentScale;
      const imgHeight = img.naturalHeight * currentScale;

      if (imgWidth > wrapperRect.width) {
        const maxOffset = (imgWidth - wrapperRect.width) / 2;
        offsetX = Math.max(-maxOffset, Math.min(maxOffset, offsetX));
      } else {
        offsetX = 0;
      }

      if (imgHeight > wrapperRect.height) {
        const maxOffset = (imgHeight - wrapperRect.height) / 2;
        offsetY = Math.max(-maxOffset, Math.min(maxOffset, offsetY));
      } else {
        offsetY = 0;
      }

      updateImageTransform(img);
    }

    // 缩放图片
    function scaleImage(factor, x, y) {
      const img = document.querySelector('.preview-image');
      if (!img) return;

      const newScale = Math.max(1, currentScale * factor);
      currentScale = newScale;

      offsetX = 0;
      offsetY = 0;

      updateImageTransform(img);
      setTimeout(constrainImagePosition, 10);
    }

    function startDrag(e) {
      e.preventDefault();
      e.stopPropagation();
      
      if (e.target.classList.contains('preview-image')) {
        isDragging = true;
        dragStartX = e.clientX - offsetX;
        dragStartY = e.clientY - offsetY;
      }
    }

    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      e.stopPropagation();
      
      if (rafId) {
        cancelAnimationFrame(rafId);
      }
      
      rafId = requestAnimationFrame(() => {
        const img = document.querySelector('.preview-image');
        if (!img) return;
        
        const wrapper = document.getElementById('previewWrapper');
        const wrapperRect = wrapper.getBoundingClientRect();
        
        const imgWidth = img.naturalWidth * currentScale;
        const imgHeight = img.naturalHeight * currentScale;
        
        let newOffsetX = e.clientX - dragStartX;
        let newOffsetY = e.clientY - dragStartY;
        
        if (imgWidth > wrapperRect.width) {
          const maxOffset = (imgWidth - wrapperRect.width) / 2;
          newOffsetX = Math.max(-maxOffset, Math.min(maxOffset, newOffsetX));
        } else {
          newOffsetX = 0;
        }
        
        if (imgHeight > wrapperRect.height) {
          const maxOffset = (imgHeight - wrapperRect.height) / 2;
          newOffsetY = Math.max(-maxOffset, Math.min(maxOffset, newOffsetY));
        } else {
          newOffsetY = 0;
        }
        
        offsetX = newOffsetX;
        offsetY = newOffsetY;
        
        img.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${currentScale})`;
        
        rafId = null;
      });
    }

    function endDrag() {
      isDragging = false;
      if (rafId) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
    }

    function navigateImage(direction) {
      const newIndex = currentIndex + direction;
      if (newIndex >= 0 && newIndex < filteredGroups.length) {
        showImage(newIndex);
      }
    }

    let magnifierEnabled = false;
    const magnifier = document.getElementById('magnifier');
    const magnifierImage = document.getElementById('magnifierImage');
    const magnifierZoom = 2.5;

    function initMagnifier() {
      const previewWrapper = document.getElementById('previewWrapper');
      
      previewWrapper.addEventListener('mousemove', (e) => {
        if (!magnifierEnabled) return;
        
        const img = document.querySelector('.preview-image');
        if (!img || e.target !== img) {
          hideMagnifier();
          return;
        }
        
        showMagnifier(e, img);
      });
      
      previewWrapper.addEventListener('mouseleave', hideMagnifier);
      
      previewWrapper.addEventListener('contextmenu', (e) => {
        if (magnifierEnabled) {
          e.preventDefault();
          toggleMagnifier(false);
        }
      });
      
      const magnifierToggle = document.getElementById('magnifierToggle');
      magnifierToggle.addEventListener('click', () => {
        toggleMagnifier(!magnifierEnabled);
      });
    }

    function toggleMagnifier(enable) {
      magnifierEnabled = enable;
      const magnifierToggle = document.getElementById('magnifierToggle');
      magnifierToggle.classList.toggle('active', magnifierEnabled);
      magnifierToggle.title = magnifierEnabled ? '放大镜 (已开启)' : '放大镜 (默认关闭)';
      if (!magnifierEnabled) {
        hideMagnifier();
      }
    }

    function showMagnifier(e, img) {
      const imgRect = img.getBoundingClientRect();
      
      if (e.clientX < imgRect.left || e.clientX > imgRect.right ||
          e.clientY < imgRect.top || e.clientY > imgRect.bottom) {
        hideMagnifier();
        return;
      }
      
      if (magnifierImage.src !== img.src) {
        magnifierImage.src = img.src;
      }
      
      const zoomedWidth = imgRect.width * magnifierZoom;
      const zoomedHeight = imgRect.height * magnifierZoom;
      
      magnifierImage.style.width = zoomedWidth + 'px';
      magnifierImage.style.height = zoomedHeight + 'px';
      
      const mouseX = e.clientX - imgRect.left;
      const mouseY = e.clientY - imgRect.top;
      
      const magnifierX = -mouseX * magnifierZoom + 100;
      const magnifierY = -mouseY * magnifierZoom + 100;
      
      magnifierImage.style.left = magnifierX + 'px';
      magnifierImage.style.top = magnifierY + 'px';
      
      magnifier.style.left = (e.clientX - 100) + 'px';
      magnifier.style.top = (e.clientY - 100) + 'px';
      
      magnifier.classList.add('visible');
    }

    function hideMagnifier() {
      magnifier.classList.remove('visible');
    }

    function resetZoom() {
      currentScale = 1;
      offsetX = 0;
      offsetY = 0;
      
      const img = document.querySelector('.preview-image');
      if (img) {
        img.style.transform = `scale(1) translate(0px, 0px)`;
      }
    }

    // 切换全屏
    function toggleFullscreen() {
      const previewWrapper = document.getElementById('previewWrapper');
      if (!document.fullscreenElement) {
        previewWrapper.requestFullscreen().catch(err => {
          console.log('无法进入全屏模式:', err);
        });
      } else {
        document.exitFullscreen();
      }
    }

    // 标记为废片
    // function markAsRejected() {
    //   const group = filteredGroups[currentIndex];
    //   if (!group) return;
      
    //   // 设置为0星表示废片
    //   setRating(0);
    // }

    // 切换标记
    function toggleMark() {
      const group = filteredGroups[currentIndex];
      if (!group) return;
      
      const fileName = group.jpg?.name || group.raw?.name;
      const currentRating = ratingsData[fileName]?.rating || 0;
      
      // 如果有星级则取消，否则设为1星
      if (currentRating > 0) {
        setRating(0);
      } else {
        setRating(1);
      }
    }

    // 全选缩略图
    function selectAllThumbnails() {
      if (!batchMode) {
        toggleBatchMode();
      }
      selectedThumbnails = new Set(filteredGroups.map((_, i) => i));
      updateThumbnailCheckboxes();
      updateBatchCount();
    }

    // 批量选择模式
    let batchMode = false;
    let selectedThumbnails = new Set();

    // 废片标记
    let rejectedImages = new Set();

    function initBatchMode() {
      const batchToggle = document.getElementById('batchToggle');
      const batchCancelInline = document.getElementById('batchCancelInline');

      batchToggle.addEventListener('click', toggleBatchMode);
      batchCancelInline.addEventListener('click', clearBatchSelection);
    }

    function toggleBatchMode() {
      batchMode = !batchMode;
      const batchToggle = document.getElementById('batchToggle');
      const batchInfoInline = document.getElementById('batchInfoInline');
      
      batchToggle.classList.toggle('active', batchMode);
      
      if (batchMode) {
        batchInfoInline.style.display = 'flex';
      } else {
        batchInfoInline.style.display = 'none';
        selectedThumbnails.clear();
      }
      
      updateThumbnailCheckboxes();
      updateBatchCount();
      
      const group = filteredGroups[currentIndex];
      if (group) {
        updateRatingDisplay(group.jpg?.path || group.raw?.path);
      }
    }

    let lastSelectedIndex = -1;

    function toggleThumbnailSelection(index, shiftKey = false) {
      if (shiftKey && lastSelectedIndex >= 0 && lastSelectedIndex !== index) {
        const start = Math.min(lastSelectedIndex, index);
        const end = Math.max(lastSelectedIndex, index);
        
        for (let i = start; i <= end; i++) {
          selectedThumbnails.add(i);
        }
      } else {
        if (selectedThumbnails.has(index)) {
          selectedThumbnails.delete(index);
        } else {
          selectedThumbnails.add(index);
        }
        lastSelectedIndex = index;
      }
      updateThumbnailCheckboxes();
      updateBatchCount();
      updateRatingDisplay(null);
    }

    function clearBatchSelection() {
      selectedThumbnails.clear();
      lastSelectedIndex = -1;
      updateThumbnailCheckboxes();
      updateBatchCount();
      updateRatingDisplay(null);
    }

    function updateThumbnailCheckboxes() {
      document.querySelectorAll('.thumbnail-checkbox').forEach(checkbox => {
        checkbox.classList.toggle('visible', batchMode);
        const index = parseInt(checkbox.dataset.index);
        checkbox.classList.toggle('checked', selectedThumbnails.has(index));
      });
      
      document.querySelectorAll('.thumbnail-item').forEach(item => {
        const index = parseInt(item.dataset.index);
        item.classList.toggle('selected', selectedThumbnails.has(index));
      });
    }

    function updateBatchCount() {
      document.getElementById('batchCountInline').textContent = selectedThumbnails.size;
    }

    function toggleRejected() {
      const group = filteredGroups[currentIndex];
      if (!group) return;

      const file = group.jpg || group.raw;
      if (!file) return;

      const fileName = file.name;
      
      if (rejectedImages.has(fileName)) {
        rejectedImages.delete(fileName);
      } else {
        rejectedImages.add(fileName);
      }

      updateRejectedBadge(currentIndex);
      updateDeleteButton();
    }

    function updateRejectedBadge(index) {
      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (!thumbnailItem) return;

      const group = filteredGroups[index];
      if (!group) return;

      const file = group.jpg || group.raw;
      if (!file) return;

      const fileName = file.name;
      const isRejected = rejectedImages.has(fileName);

      const ratingDiv = thumbnailItem.querySelector('.thumbnail-rating');
      if (ratingDiv) {
        if (isRejected) {
          ratingDiv.classList.add('rejected');
        } else {
          ratingDiv.classList.remove('rejected');
        }
      }
    }

    function updateDeleteButton() {
      const deleteBtn = document.getElementById('deleteButton');
      if (rejectedImages.size > 0) {
        deleteBtn.disabled = false;
        deleteBtn.classList.remove('disabled');
      } else {
        deleteBtn.disabled = true;
        deleteBtn.classList.add('disabled');
      }
    }

    // 删除对话框
    function showDeleteModal() {
      if (rejectedImages.size === 0) return;
      document.getElementById('rejectedCount').textContent = rejectedImages.size;
      document.getElementById('deleteModal').classList.add('visible');
    }

    function hideDeleteModal() {
      document.getElementById('deleteModal').classList.remove('visible');
    }

    async function deleteRejectedFiles(mode) {
      hideDeleteModal();
      
      const filesToDelete = [];
      
      for (const fileName of rejectedImages) {
        const group = imageGroups.find(g => 
          (g.jpg && g.jpg.name === fileName) || 
          (g.raw && g.raw.name === fileName)
        );
        
        if (!group) continue;
        
        if (mode === 'both') {
          if (group.jpg) filesToDelete.push(group.jpg.path);
          if (group.raw) filesToDelete.push(group.raw.path);
        } else if (mode === 'jpg' && group.jpg) {
          filesToDelete.push(group.jpg.path);
        } else if (mode === 'raw' && group.raw) {
          filesToDelete.push(group.raw.path);
        }
      }

      if (filesToDelete.length === 0) {
        showMessage('提示', '没有可删除的文件', 'info');
        return;
      }

      showProgress('删除文件...');
      let deleted = 0;

      for (const filePath of filesToDelete) {
        try {
          await window.electronAPI.fs.deleteFile(filePath);
          deleted++;
          updateProgress(deleted, filesToDelete.length);
        } catch (error) {
          console.error(`删除文件失败: ${filePath}`, error);
        }
      }

      hideProgress();
      
      // 清空废片标记
      rejectedImages.clear();
      updateDeleteButton();
      
      // 重新加载图片
      await loadImages();
      
      showMessage('删除完成', `已删除 ${deleted} 个文件`, 'info');
    }

    async function batchSetRating(rating) {
      if (selectedThumbnails.size === 0) {
        showMessage('提示', '请先选择图片', 'info');
        return;
      }

      let allSameRating = true;
      for (const index of selectedThumbnails) {
        const group = filteredGroups[index];
        if (!group) continue;
        const file = group.jpg || group.raw;
        if (!file) continue;
        const currentRating = ratingsData[file.name]?.rating || 0;
        if (currentRating !== rating) {
          allSameRating = false;
          break;
        }
      }

      const targetRating = allSameRating ? 0 : rating;
      const actionText = allSameRating ? '取消评级...' : '批量设置评级...';

      showProgress(actionText);
      let processed = 0;
      const total = selectedThumbnails.size;

      for (const index of selectedThumbnails) {
        const group = filteredGroups[index];
        if (!group) continue;

        if (group.jpg) {
          const fileName = group.jpg.name;
          if (!ratingsData[fileName]) {
            ratingsData[fileName] = { rating: 0, tags: [] };
          }
          ratingsData[fileName].rating = targetRating;
          window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[fileName].rating);
        }
        if (group.raw) {
          const fileName = group.raw.name;
          if (!ratingsData[fileName]) {
            ratingsData[fileName] = { rating: 0, tags: [] };
          }
          ratingsData[fileName].rating = targetRating;
          window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[fileName].rating);
        }

        processed++;
        updateProgress(processed, total);
      }

      hideProgress();
      updateThumbnailRatings();
      updateRatingStats();
      
      const resultText = targetRating === 0 
        ? `已取消 ${total} 张图片的评级` 
        : `已将 ${total} 张图片设为 ${targetRating} 星`;
      showQuickToast(resultText);
    }

    function showQuickToast(message) {
      let toast = document.getElementById('quickToast');
      const previewContainer = document.querySelector('.preview-container');
      
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'quickToast';
        toast.style.cssText = `
          position: absolute;
          bottom: 60px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(40, 40, 40, 0.85);
          color: #e0e0e0;
          padding: 8px 20px;
          border-radius: 20px;
          font-size: 13px;
          z-index: 100;
          opacity: 0;
          transition: opacity 0.3s ease;
          pointer-events: none;
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
        `;
        previewContainer.appendChild(toast);
      } else if (toast.parentElement !== previewContainer) {
        previewContainer.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.opacity = '0';
      }, 2000);
    }

    function updateThumbnailRatings() {
      const items = document.querySelectorAll('.thumbnail-item');
      items.forEach((item, index) => {
        const group = filteredGroups[index];
        if (!group) return;
        
        const thumbnailFile = group.jpg || group.raw;
        if (!thumbnailFile) return;
        
        const fileName = thumbnailFile.name;
        const rating = ratingsData[fileName]?.rating || 0;
        
        const stars = item.querySelectorAll('.thumbnail-star');
        stars.forEach((star, i) => {
          if (i < rating) {
            star.classList.add('active');
          } else {
            star.classList.remove('active');
          }
        });
        
        const ratingContainer = item.querySelector('.thumbnail-rating');
        if (rejectedImages.has(fileName)) {
          ratingContainer.classList.add('rejected');
        } else {
          ratingContainer.classList.remove('rejected');
        }
      });
    }

    function batchToggleRejected() {
      if (selectedThumbnails.size === 0) {
        showMessage('提示', '请先选择图片', 'info');
        return;
      }

      let addedCount = 0;
      let removedCount = 0;

      for (const index of selectedThumbnails) {
        const group = filteredGroups[index];
        if (!group) continue;

        const file = group.jpg || group.raw;
        if (!file) continue;

        const fileName = file.name;
        
        if (rejectedImages.has(fileName)) {
          rejectedImages.delete(fileName);
          removedCount++;
        } else {
          rejectedImages.add(fileName);
          addedCount++;
        }

        updateRejectedBadge(index);
      }

      updateDeleteButton();
      
      // const message = [];
      // if (addedCount > 0) message.push(`标记 ${addedCount} 张`);
      // if (removedCount > 0) message.push(`取消 ${removedCount} 张`);
      // showMessage('完成', message.join('，'), 'info');
    }

    let exifPanelVisible = false;

    function initExifPanel() {
      const exifToggle = document.getElementById('exifToggle');
      const exifPanel = document.getElementById('exifPanel');
      const exifClose = document.getElementById('exifClose');

      exifToggle.addEventListener('click', () => {
        exifPanelVisible = !exifPanelVisible;
        exifPanel.classList.toggle('visible', exifPanelVisible);
        exifToggle.classList.toggle('active', exifPanelVisible);
        
        if (exifPanelVisible) {
          updateExifDisplay();
        }
      });

      exifClose.addEventListener('click', () => {
        exifPanelVisible = false;
        exifPanel.classList.remove('visible');
        exifToggle.classList.remove('active');
      });
    }

    async function updateExifDisplay() {
      const group = filteredGroups[currentIndex];
      if (!group) {
        clearExifDisplay();
        return;
      }

      const file = group.jpg || group.raw;
      if (!file) return;

      try {
        const metadata = await window.electronAPI.image.readMetadata(file.path);
        if (metadata) {
          displayExifData(metadata, file);
        } else {
          clearExifDisplay();
        }
      } catch (error) {
        console.error('读取EXIF信息失败:', error);
        clearExifDisplay();
      }
    }

    function displayExifData(metadata, file) {
      // 相机信息
      const camera = metadata.Make || metadata.Model || metadata['Model'] || metadata['Make'];
      document.getElementById('exifCamera').textContent = camera ? camera.description : '-';

      const lens = metadata.LensModel || metadata.Lens || metadata['LensModel'];
      document.getElementById('exifLens').textContent = lens ? lens.description : '-';

      // 拍摄参数
      const aperture = metadata.FNumber || metadata.ApertureValue || metadata['FNumber'];
      document.getElementById('exifAperture').textContent = aperture ? `f/${aperture.description}` : '-';

      const shutter = metadata.ExposureTime || metadata.ShutterSpeedValue || metadata['ExposureTime'];
      document.getElementById('exifShutter').textContent = shutter ? formatShutter(shutter.description) : '-';

      const iso = metadata.ISO || metadata.ISOSpeedRatings || metadata['ISOSpeedRatings'];
      document.getElementById('exifISO').textContent = iso ? iso.description : '-';

      const focalLength = metadata.FocalLength || metadata['FocalLength'];
      document.getElementById('exifFocalLength').textContent = focalLength ? `${focalLength.description}mm` : '-';

      const exposureBias = metadata.ExposureBiasValue || metadata['ExposureBiasValue'];
      document.getElementById('exifExposureBias').textContent = exposureBias ? `${exposureBias.description} EV` : '-';

      // 图片信息
      const width = metadata['Image Width'] || metadata.PixelXDimension || metadata['PixelXDimension'];
      const height = metadata['Image Height'] || metadata.PixelYDimension || metadata['PixelYDimension'];
      document.getElementById('exifResolution').textContent = width && height ? `${width.description} × ${height.description}` : '-';

      const dateTime = metadata.DateTime || metadata.CreateDate || metadata['DateTimeOriginal'];
      document.getElementById('exifDateTime').textContent = dateTime ? formatDateTime(dateTime.description) : '-';

      // 文件大小 - 通过IPC获取
      window.electronAPI.fs.stat(file.path).then(stats => {
        const fileSizeMB = (stats.size / (1024 * 1024)).toFixed(2);
        document.getElementById('exifFileSize').textContent = `${fileSizeMB} MB`;
      }).catch(() => {
        document.getElementById('exifFileSize').textContent = '-';
      });

      document.getElementById('exifFileName').textContent = file.name || '-';
    }

    function clearExifDisplay() {
      document.getElementById('exifCamera').textContent = '-';
      document.getElementById('exifLens').textContent = '-';
      document.getElementById('exifAperture').textContent = '-';
      document.getElementById('exifShutter').textContent = '-';
      document.getElementById('exifISO').textContent = '-';
      document.getElementById('exifFocalLength').textContent = '-';
      document.getElementById('exifExposureBias').textContent = '-';
      document.getElementById('exifResolution').textContent = '-';
      document.getElementById('exifDateTime').textContent = '-';
      document.getElementById('exifFileSize').textContent = '-';
      document.getElementById('exifFileName').textContent = '-';
    }

    function formatShutter(value) {
      const num = parseFloat(value);
      if (isNaN(num)) return value;
      if (num >= 1) return `${num}s`;
      return `1/${Math.round(1 / num)}s`;
    }

    function formatDateTime(value) {
      if (!value) return '-';
      // EXIF日期格式: YYYY:MM:DD HH:mm:ss
      const match = value.match(/(\d{4}):(\d{2}):(\d{2}) (\d{2}):(\d{2}):(\d{2})/);
      if (match) {
        return `${match[1]}-${match[2]}-${match[3]} ${match[4]}:${match[5]}:${match[6]}`;
      }
      return value;
    }



    // 更新星级显示
    function updateRatingDisplay(filePath) {
      const stars = document.querySelectorAll('.star');
      
      if (batchMode && selectedThumbnails.size > 0) {
        stars.forEach(star => {
          star.classList.remove('active');
        });
        return;
      }
      
      const fileName = filePath ? filePath.split(/[/\\]/).pop() : '';
      const rating = fileName ? (ratingsData[fileName]?.rating || 0) : 0;

      stars.forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= rating);
      });
    }

    // 设置星级
    async function setRating(rating) {
      // 如果在批量模式下，调用批量评级
      if (batchMode && selectedThumbnails.size > 0) {
        await batchSetRating(rating);
        return;
      }

      const group = filteredGroups[currentIndex];
      if (!group) return;

      if (group.jpg) {
        updateRating(group.jpg.path, rating);
        window.electronAPI.image.saveRatingAsync(group.jpg.path, ratingsData[group.jpg.name].rating);
      }
      if (group.raw) {
        updateRating(group.raw.path, rating);
        window.electronAPI.image.saveRatingAsync(group.raw.path, ratingsData[group.raw.name].rating);
      }

      updateRatingDisplay(group.jpg?.path || group.raw?.path);
      
      const thumbnailItem = document.querySelector(`.thumbnail-item[data-index="${currentIndex}"]`);
      if (thumbnailItem) {
        const actualRating = ratingsData[group.jpg?.name || group.raw?.name]?.rating || 0;
        const stars = thumbnailItem.querySelectorAll('.thumbnail-star');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating);
          star.classList.toggle('active', starRating <= actualRating);
        });
      }
    }

    // 更新星级数据
    function updateRating(filePath, rating) {
      // 使用文件名作为键
      const fileName = filePath.split(/[/\\]/).pop();
      if (!ratingsData[fileName]) {
        ratingsData[fileName] = { rating: 0, tags: [] };
      }

      // 如果点击的是当前星级，则取消评级
      if (ratingsData[fileName].rating === rating) {
        ratingsData[fileName].rating = 0;
      } else {
        ratingsData[fileName].rating = rating;
      }
    }

    // 更新缩略图选中状态
    function updateThumbnailSelection(index) {
      document.querySelectorAll('.thumbnail-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeItem = document.querySelector(`.thumbnail-item[data-index="${index}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
        // 滚动到可见区域
        scrollThumbnailIntoView(activeItem);
      }
    }

    // 滚动缩略图到可见区域
    function scrollThumbnailIntoView(thumbnailItem) {
      const container = document.getElementById('thumbnailContainer');
      const itemRect = thumbnailItem.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      // 计算缩略图相对于容器的位置
      const itemLeft = itemRect.left - containerRect.left;
      const itemRight = itemRect.right - containerRect.left;
      const itemWidth = itemRect.width;
      
      // 检查是否在可见区域内
      const isFullyVisible = itemLeft >= 0 && itemRight <= containerRect.width;
      
      if (isFullyVisible) return;
      
      // 判断缩略图在左侧还是右侧
      if (itemLeft < 0) {
        // 缩略图在左侧，滚动到左侧对齐
        container.scrollTo({
          left: thumbnailItem.offsetLeft - 10,
          behavior: 'instant'
        });
      } else if (itemRight > containerRect.width) {
        // 缩略图在右侧，滚动到右侧对齐
        container.scrollTo({
          left: thumbnailItem.offsetLeft - containerRect.width + itemWidth + 10,
          behavior: 'instant'
        });
      }
    }

    // 更新筛选状态
    function updateFilterStatus() {
      const statusElement = document.getElementById('filterStatus');
      let statusText = '未筛选';

      if (filterCondition !== 'all') {
        switch (filterCondition) {
          case 'equal':
            statusText = `已筛选：=${filterRating}星`;
            break;
          case 'greater':
            statusText = `已筛选：≥${filterRating}星`;
            break;
          case 'less':
            statusText = `已筛选：≤${filterRating}星`;
            break;
          case 'none':
            statusText = '已筛选：无星';
            break;
          case 'any':
            statusText = '已筛选：有星';
            break;
        }
      }

      statusElement.textContent = statusText;
    }

    // 设置筛选条件
    function setFilterCondition(filter) {
      filterCondition = filter;
      
      // 更新按钮状态
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      
      // 如果筛选条件需要星级，使用已选中的星级
      const needStars = ['equal', 'greater', 'less'].includes(filter);
      if (needStars && selectedFilterRating > 0) {
        filterRating = selectedFilterRating;
      } else if (!needStars) {
        filterRating = 0;
        selectedFilterRating = 0;
        document.querySelectorAll('.filter-star').forEach(star => {
          star.classList.remove('active');
        });
      }
      
      // 更新筛选状态提示
      updateFilterStatusForRating();
      
      applyFilter();
    }

    // 设置筛选星级（只选中，不立即筛选）
    let selectedFilterRating = 0;

    function setFilterRating(rating) {
      // 如果点击的是当前星级，则取消选中
      if (selectedFilterRating === rating) {
        selectedFilterRating = 0;
      } else {
        selectedFilterRating = rating;
      }

      // 更新筛选星级显示
      document.querySelectorAll('.filter-star').forEach(star => {
        const starRating = parseInt(star.dataset.rating);
        star.classList.toggle('active', starRating <= selectedFilterRating);
      });

      // 更新筛选状态提示
      updateFilterStatusForRating();
    }

    function updateFilterStatusForRating() {
      const statusElement = document.getElementById('filterStatus');
      if (selectedFilterRating > 0) {
        statusElement.textContent = `已选 ${selectedFilterRating} 星，点击筛选按钮确认`;
      } else {
        statusElement.textContent = filterCondition === 'all' ? '未筛选' : getFilterStatusText();
      }
    }

    function getFilterStatusText() {
      switch (filterCondition) {
        case 'equal': return `等于 ${filterRating} 星`;
        case 'greater': return `≥ ${filterRating} 星`;
        case 'less': return `≤ ${filterRating} 星`;
        case 'none': return '无星';
        case 'any': return '有星';
        default: return '未筛选';
      }
    }

    // 导出文件
    async function exportFiles() {
      try {
        // 选择导出目录
        const exportPath = await window.electronAPI.openDirectoryDialog({
          title: '选择导出目录',
          defaultPath: ''
        });

        if (!exportPath) return;

        // 统计需要导出的文件
        const filesToExport = [];
        for (const group of imageGroups) {
          const file = group.jpg || group.raw;
          const fileName = file.name;
          const rating = ratingsData[fileName]?.rating || 0;
          
          if (rating > 0) {
            filesToExport.push({ group, rating });
          }
        }

        if (filesToExport.length === 0) {
          showMessage('提示', '没有需要导出的文件', 'info');
          return;
        }

        // 显示进度指示器
        showProgress('导出文件...');
        
        let jpgCount = 0;
        let rawCount = 0;
        let processedCount = 0;

        // 遍历需要导出的文件
        for (const { group, rating } of filesToExport) {
          // 4星及以下：仅导出JPG
          if (rating <= 4 && group.jpg) {
            const targetPath = joinPath(exportPath, 'JPG_Export', group.jpg.name);
            await window.electronAPI.fs.copyFile(group.jpg.path, targetPath);
            jpgCount++;
          }
          // 5星：导出JPG和RAW
          else if (rating === 5) {
            if (group.jpg) {
              const targetPath = joinPath(exportPath, 'JPG_Export', group.jpg.name);
              await window.electronAPI.fs.copyFile(group.jpg.path, targetPath);
              jpgCount++;
            }
            if (group.raw) {
              const targetPath = joinPath(exportPath, 'RAW_Export', group.raw.name);
              await window.electronAPI.fs.copyFile(group.raw.path, targetPath);
              rawCount++;
            }
          }
          
          processedCount++;
          updateProgress(processedCount, filesToExport.length, `导出: ${processedCount} / ${filesToExport.length}`);
        }

        hideProgress();
        showMessage('导出完成', `导出完成：${jpgCount}个JPG文件，${rawCount}个RAW文件`, 'info');
      } catch (error) {
        console.error('导出文件失败:', error);
        hideProgress();
        showMessage('错误', '导出文件失败', 'error');
      }
    }

    // 加载星级数据 - 使用批量并发处理优化性能
    async function loadRatingsData() {
      try {
        // 初始化ratingsData对象
        ratingsData = {};
        
        // 批量并发读取评级数据，每批处理20个文件
        const batchSize = 20;
        const allFiles = [];
        
        // 收集所有需要读取评级的文件
        for (const group of imageGroups) {
          if (group.jpg) {
            allFiles.push({ file: group.jpg, type: 'jpg' });
          }
          if (group.raw) {
            allFiles.push({ file: group.raw, type: 'raw' });
          }
        }
        
        const totalFiles = allFiles.length;
        let processedFiles = 0;
        
        // 分批处理
        for (let i = 0; i < allFiles.length; i += batchSize) {
          const batch = allFiles.slice(i, i + batchSize);
          
          // 并发读取当前批次的评级
          const ratings = await Promise.all(
            batch.map(async ({ file }) => {
              try {
                const rating = await window.electronAPI.image.readRating(file.path);
                return { fileName: file.name, rating };
              } catch (error) {
                console.error(`读取文件 ${file.name} 评级失败:`, error);
                return { fileName: file.name, rating: 0 };
              }
            })
          );
          
          // 存储评级数据
          ratings.forEach(({ fileName, rating }) => {
            ratingsData[fileName] = { rating, tags: [] };
          });
          
          // 更新进度
          processedFiles += batch.length;
          if (totalFiles > 0) {
            updateProgress(processedFiles, totalFiles, `加载评级数据... ${processedFiles}/${totalFiles}`);
          }
        }
      } catch (error) {
        console.error('加载星级数据失败:', error);
        ratingsData = {};
      }
    }


    function showMessage(title, message, type) {
      window.electronAPI.showMessageBox({
        title: title,
        message: message,
        type: type
      });
    }

    function initThumbnailResize() {
      const handle = document.getElementById('thumbnailResizeHandle');
      const container = document.getElementById('thumbnailContainer');
      
      let isResizing = false;
      let startY = 0;
      let startHeight = 0;
      
      handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startY = e.clientY;
        startHeight = container.offsetHeight;
        document.body.style.cursor = 'ns-resize';
        document.body.style.userSelect = 'none';
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const deltaY = startY - e.clientY;
        const newHeight = Math.max(80, Math.min(400, startHeight + deltaY));
        container.style.height = newHeight + 'px';
      });
      
      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    }

    function initViewToggle() {
      const viewBtns = document.querySelectorAll('.view-btn');
      
      viewBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const view = btn.dataset.view;
          setView(view);
        });
      });
    }
    
    function setView(view) {
      currentView = view;
      
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      const container = document.querySelector('.container');
      container.classList.remove('list-view', 'detail-view');
      
      if (view === 'detail') {
        container.classList.add('detail-view');
      }
      
      updateThumbnails(filteredGroups);
    }

    // function initThemeSelector() {
    //   // const themeBtn = document.getElementById('themeBtn');
    //   const themeDropdown = document.getElementById('themeDropdown');
      
    //   // themeBtn.addEventListener('click', (e) => {
    //   //   e.stopPropagation();
    //   //   themeDropdown.classList.toggle('visible');
    //   // });
      
    //   document.addEventListener('click', () => {
    //     themeDropdown.classList.remove('visible');
    //   });
      
    //   themeDropdown.addEventListener('click', (e) => {
    //     e.stopPropagation();
    //   });
      
    //   document.querySelectorAll('.theme-option').forEach(option => {
    //     option.addEventListener('click', () => {
    //       const theme = option.dataset.theme;
    //       setTheme(theme);
    //       themeDropdown.classList.remove('visible');
    //     });
    //   });
    // }
    
    function setTheme(theme) {
      currentTheme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      
      document.querySelectorAll('.theme-option').forEach(option => {
        option.classList.toggle('active', option.dataset.theme === theme);
      });
    }

    function initFileTooltip() {
      const tooltip = document.getElementById('fileTooltip');
      
      document.addEventListener('mouseover', async (e) => {
        const thumbnailItem = e.target.closest('.thumbnail-item');
        if (!thumbnailItem) {
          hideFileTooltip();
          return;
        }
        
        const index = parseInt(thumbnailItem.dataset.index);
        const group = filteredGroups[index];
        if (!group) return;
        
        const file = group.jpg || group.raw;
        if (!file) return;
        
        tooltipTimeout = setTimeout(() => {
          showFileTooltip(e, file, group);
        }, 500);
      });
      
      document.addEventListener('mouseout', (e) => {
        if (e.target.closest('.thumbnail-item')) {
          clearTimeout(tooltipTimeout);
          hideFileTooltip();
        }
      });
      
      document.addEventListener('mousemove', (e) => {
        if (tooltip.classList.contains('visible')) {
          positionTooltip(e);
        }
      });
    }
    
    async function showFileTooltip(e, file, group) {
      const tooltip = document.getElementById('fileTooltip');
      
      document.getElementById('tooltipFileName').textContent = file.name;
      
      const rating = ratingsData[file.name]?.rating || 0;
      document.getElementById('tooltipRating').textContent = rating > 0 ? `${rating}星` : '未评级';
      
      let cachedMeta = fileMetadataCache.get(file.path);
      
      if (!cachedMeta) {
        try {
          const [stats, metadata] = await Promise.all([
            window.electronAPI.fs.stat(file.path),
            window.electronAPI.image.readMetadata(file.path)
          ]);
          
          cachedMeta = {
            size: (stats.size / (1024 * 1024)).toFixed(2),
            width: null,
            height: null
          };
          
          if (metadata) {
            const w = metadata['Image Width'] || metadata.PixelXDimension;
            const h = metadata['Image Height'] || metadata.PixelYDimension;
            cachedMeta.width = w ? (w.description || w) : null;
            cachedMeta.height = h ? (h.description || h) : null;
          }
          
          fileMetadataCache.set(file.path, cachedMeta);
        } catch (err) {
          cachedMeta = { size: '-', width: null, height: null };
        }
      }
      
      document.getElementById('tooltipFileSize').textContent = `${cachedMeta.size} MB`;
      
      if (cachedMeta.width && cachedMeta.height) {
        document.getElementById('tooltipResolution').textContent = 
          `${cachedMeta.width} × ${cachedMeta.height}`;
      } else {
        document.getElementById('tooltipResolution').textContent = '-';
      }
      
      positionTooltip(e);
      tooltip.classList.add('visible');
    }
    
    function hideFileTooltip() {
      const tooltip = document.getElementById('fileTooltip');
      tooltip.classList.remove('visible');
    }
    
    function positionTooltip(e) {
      const tooltip = document.getElementById('fileTooltip');
      const padding = 15;
      
      let x = e.clientX + padding;
      let y = e.clientY + padding;
      
      const rect = tooltip.getBoundingClientRect();
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      
      if (x + rect.width > windowWidth - padding) {
        x = e.clientX - rect.width - padding;
      }
      
      if (y + rect.height > windowHeight - padding) {
        y = e.clientY - rect.height - padding;
      }
      
      tooltip.style.left = x + 'px';
      tooltip.style.top = y + 'px';
    }

    function updateRatingStats() {
      const stats = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
      let jpgOnly = 0;
      let rawOnly = 0;
      let both = 0;
      
      imageGroups.forEach(group => {
        const file = group.jpg || group.raw;
        if (file) {
          const rating = ratingsData[file.name]?.rating || 0;
          stats[rating]++;
        }
        
        if (group.jpg && group.raw) {
          both++;
        } else if (group.jpg) {
          jpgOnly++;
        } else if (group.raw) {
          rawOnly++;
        }
      });
      
      const total = imageGroups.length;
      
      document.querySelector('#statsJpgOnly span').textContent = jpgOnly;
      document.querySelector('#statsRawOnly span').textContent = rawOnly;
      document.querySelector('#statsBoth span').textContent = both;
      document.querySelector('#statsTotal span').textContent = total;
      
      document.getElementById('filterStar5').textContent = stats[5];
      document.getElementById('filterStar4').textContent = stats[4];
      document.getElementById('filterStar3').textContent = stats[3];
      document.getElementById('filterStar2').textContent = stats[2];
      document.getElementById('filterStar1').textContent = stats[1];
    }

    function setFormatFilter(filter) {
      formatFilter = filter;
      
      document.querySelectorAll('.title-bar-stats-row:first-child .title-bar-stats-item').forEach(item => {
        item.classList.remove('active');
      });
      
      if (filter === 'jpg') {
        document.getElementById('statsJpgOnly').classList.add('active');
      } else if (filter === 'raw') {
        document.getElementById('statsRawOnly').classList.add('active');
      } else if (filter === 'both') {
        document.getElementById('statsBoth').classList.add('active');
      } else {
        document.getElementById('statsTotal').classList.add('active');
      }
      
      applyFilter();
    }

    function showProgress(title) {
      const progress = document.getElementById('headerProgress');
      const bar = document.getElementById('headerProgressBar');
      bar.classList.remove('complete');
      document.getElementById('headerProgressText').textContent = title || '处理中...';
      bar.style.width = '0%';
      progress.classList.add('visible');
    }

    function hideProgress() {
      const progress = document.getElementById('headerProgress');
      const bar = document.getElementById('headerProgressBar');
      bar.classList.add('complete');
      setTimeout(() => {
        progress.classList.remove('visible');
        bar.classList.remove('complete');
      }, 600);
    }

    function updateProgress(current, total, text, detail) {
      const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
      document.getElementById('headerProgressBar').style.width = percentage + '%';
      const progressText = text || `${current} / ${total}`;
      const title = document.getElementById('headerProgressText').textContent.split(' - ')[0];
      document.getElementById('headerProgressText').textContent = `${title} - ${progressText} (${percentage}%)`;
    }


  </script>
</body>
</html>